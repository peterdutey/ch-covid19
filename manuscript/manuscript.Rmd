---
title: "Covid-19 infection and attributable mortality in UK long term care facilities: Cohort study using active surveillance and electronic records (March-June 2020)"
bibliography: references.bib
csl: sage-vancouver.csl
output:
  html_document:
    df_print: paged
    toc: yes
    code_folding: hide
  word_document:
    toc: yes
    reference_docx: template.docx
link-citations: yes
always_allow_html: yes
---

Peter Dutey Magni,$^{12}$ Haydn Williams,$^{3}$ Arnoupe Jhass,$^{4}$ Greta Rait,$^4$ Harry Hemingway,$^{125}$ Andrew Hayward,$^{6}$ Laura Shallcross$^{12*}$


$^1$ Institute of Health Informatics, University College London, London, UK

$^2$ Health Data Research UK, University College London, London, UK

$^3$ Four Seasons Health Care Group, Norcliffe House, Station Road, Wilmslow, Cheshire, UK

$^4$ Primary Care & Population Health, University College London, London, UK

$^5$ University College London Hospitals NIHR Biomedical Research Centre, London, UK

$^6$ Institute of Epidemiology & Health Care, University College London, London, UK

$*$ Corresponding author

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE)
knit_output_pdf <- F
if(knit_output_pdf){
  options(knitr.table.format = "pdf")
} else {
  options(knitr.table.format = "pandoc")
}

source("../.Rprofile")
devtools::load_all("..")
load_data()
library(dplyr)
library(lubridate)
library(kableExtra)
library(captioner)
library(survival)
library(survminer)
library(ggplot2)
library(finalfit)
# override the finalfit cox PH modelling which defaults to Efron ties
# using Breslow ties instead
# coxphmulti <- function (.data, dependent, explanatory) {
#     requireNamespace("survival")
#     coxph(as.formula(paste0(dependent, "~", paste(explanatory, 
#         collapse = "+"))), data = .data, ties = "breslow")
# }
# assignInNamespace("coxphmulti",coxphmulti,ns="finalfit")


knit_output_pdf <- F
if(knit_output_pdf){
  options(knitr.table.format = "pdf")
} else {
  options(knitr.table.format = "pandoc")
}

date_min <- as.Date("2020-03-02")
date_max <- as.Date("2020-06-14")
date_min_tallies = as.Date("2020-03-24")
date_max_tallies = as.Date("2020-06-14")
date_min_cox_mortality <- as.Date("2020-04-01")

```

```{r init_data}

tline <- dplyr::bind_rows(timelines$timeline)
stopifnot(unique(tline$date_end)>=date_max)
tline <- filter(tline, between(date, date_min, date_max)) %>% 
  mutate(home_type = factor(home_type, c("Residential", "Nursing"))) %>% 
  mutate(
    user_type2 = as.factor(case_when(
      user_type %in% c("General", "Elderly") ~ "General/elderly",
      user_type == "Dementia" ~ "Dementia",
      TRUE ~ NA_character_ 
      )),
    admission_type2 = case_when(
      admission_type %in% c("Continuing Care", "Independent Living") ~ "Continuing care/independent living", 
      TRUE ~ admission_type
    )) %>% 
  mutate(
    user_type2 = relevel(user_type2, "General/elderly")
  )

home_inclusion <- unique(tline$home_code)

reference_homes <- reference_homes %>% 
  filter(home_code %in% home_inclusion) %>% 
  left_join(select(filter(beds, year=="2020"), -year)) %>% 
  mutate(staff_to_bed_ratio = staff_total/beds,
         carer_to_bed_ratio = (staff_care_assistants + staff_nurses)/beds,
         bed_tot_category = cut(.$beds, 
           breaks = seq(20,100,25), right = F, 
           paste0(seq(20, 80, 25), "–", seq(34, 94, 25), " beds"))
         ) %>% 
  mutate(staff_to_bed_ratio_g5 = cut(
    staff_to_bed_ratio, c(min(staff_to_bed_ratio)-.001,
    quantile(staff_to_bed_ratio, seq(.2, .8, .2)),
    max(staff_to_bed_ratio))))

homes_country <- select(reference_homes, home_code, postcode) %>% 
  left_join(transmute(reference_geography, postcode, 
                      country, region_england = region,
                      uk_imd_england_quintile), by = "postcode") %>% 
  mutate(region_UK = if_else(country == "England", region_england, country)) %>% 
  select(-postcode)
reference_homes <- left_join(reference_homes, homes_country)
rm(homes_country)

incidents <- incidents %>% 
  filter(dplyr::between(incident_date, date_min, date_max)) %>% 
  filter(home_code %in% home_inclusion)

desc_before_exclusions <- list()
desc_before_exclusions$nrow_incidents <- nrow(incidents)
desc_before_exclusions$missing_id <- sum(grepl("^MISSING", incidents$resident_id))
desc_before_exclusions$missing_id_pct <- mean(grepl("^MISSING", incidents$resident_id))*100
desc_before_exclusions$link_fail <- sum(!incidents$resident_id[
  which(!grepl("^MISSING", incidents$resident_id))] %in% unique(residents$resident_id))
desc_before_exclusions$link_fail_pct <- tbrounding(
  sum(!incidents$resident_id[
    which(!grepl("^MISSING", incidents$resident_id))] %in% unique(residents$resident_id)) / 
    nrow(incidents)*100) 


# removing erroneous incident reports (no identifier or not linking to residents file) 
incidents <- filter(incidents, !grepl("^MISSING", resident_id)) %>% 
  filter(resident_id %in% unique(residents$resident_id))

new_cases <- filter(new_cases, between(date, date_min, date_max_tallies)) %>% 
    filter(home_code %in% home_inclusion)

approx_occupancy <- tline %>% 
  group_by(home_code, date) %>% 
  summarise(
    occupancy = sum(tidyr::replace_na(rday, 0)),
    susceptible_symptomatic = sum(susceptible_symptomatic, na.rm = T),
    susceptible_confirmed = sum(susceptible_confirmed, na.rm = T))
approx_occupancy <- merge(
  tibble(date = seq(date_min, date_max, 1)),
  tibble(home_code = home_inclusion),
  all = TRUE) %>% 
  left_join(approx_occupancy)

occupancy_interpolated <- resident_days_linear_approx() #%>% 
home_mean_occupancy <- occupancy_interpolated  %>% 
  filter(between(date, as.Date("2020-01-01"), as.Date("2020-03-14"))) %>%
  group_by(home_code) %>% 
  summarise(mean_occupancy = mean(occupancy, na.rm = T))  

reference_homes <- reference_homes %>% 
  left_join(home_mean_occupancy) %>% 
  mutate(pct_occupancy = mean_occupancy/beds,
         occ_bedroom_ratio = mean_occupancy/no_bedrooms)


reference_homes <- reference_homes %>% 
  mutate(occ_bedroom_ratio_g5 = cut(occ_bedroom_ratio, seq(0.2, 1.2, .2)),
         occ_bedroom_ratio_g6 = cut(occ_bedroom_ratio, seq(0.25, 1.2, .15)),
         region_UK = as.factor(region_UK)) %>% 
  mutate(occ_bedroom_ratio_g6 = relevel(occ_bedroom_ratio_g6, '(0.7,0.85]'),
         occ_bedroom_ratio_g5 = relevel(occ_bedroom_ratio_g5, '(0.8,1]'),
         region_UK <- relevel(region_UK, "Scotland")) 

residents_overview <- tline %>% 
  filter(rday==1) %>%
  mutate(ageg = cut_age_denary(compute_age(dob, date_min), age.min = 75, age.max = 95)) %>% 
  group_by(resident_id, home_code, ageg, gender, 
           admission_type2, home_type, user_type2, status) %>% 
  summarise(resident_days = sum(rday),
            susceptible_symptomatic_days = sum(susceptible_symptomatic),
            susceptible_confirmed_days = sum(susceptible_confirmed),
            symptomatic = max(-susceptible_symptomatic+1, na.rm = T),
            confirmed = max(-susceptible_confirmed+1, na.rm = T),
            start_date = min(date, na.rm = T),
            stop_date = max(date, na.rm = T),
            start_int = as.numeric(min(date, na.rm = T) - date_min),
            stop_int = as.numeric(max(date, na.rm = T)- date_min)
    ) %>% 
  ungroup() %>% 
  mutate(covid_status = case_when(
    symptomatic==0 & confirmed == 0 ~ "Uninfected",
    symptomatic==1 & confirmed == 0 ~ "Symptomatic (not confirmed)",
    symptomatic==0 & confirmed == 1 ~ "Asymptomatic confirmed",
    symptomatic==1 & confirmed == 1 ~ "Symptomatic confirmed"
  )) %>% 
  mutate(covid_status = factor(covid_status, 
                               levels = c("Uninfected", "Symptomatic (not confirmed)",
                                          "Asymptomatic confirmed", "Symptomatic confirmed"))) %>% 
  left_join(select(reference_homes, home_code, country, region_UK,
                   staff_to_bed_ratio, staff_to_bed_ratio_g5, carer_to_bed_ratio, bed_tot_category,
                   beds,  pct_occupancy, no_bedrooms, uk_imd_england_quintile,
                   occ_bedroom_ratio, occ_bedroom_ratio_g5, occ_bedroom_ratio_g6)) %>% 
  left_join(distinct(select(incidents, resident_id, starts_with("covid_first")))) 

home_first_case <- bind_rows(
  new_cases %>% 
    dplyr::filter(tidyr::replace_na(new_deaths_hospital, 0) > 0 |
                    tidyr::replace_na(new_deaths_home, 0)>0) %>% 
    dplyr::group_by(home_code) %>% 
    dplyr::summarise(first_case_date = min(date),
                     source = "CT"),
  residents_overview %>% 
    dplyr::filter(confirmed == 1) %>% 
    dplyr::group_by(home_code) %>% 
    dplyr::summarise(first_case_date = min(covid_first_confirmed, na.rm = T), source="DAT")
) %>% 
  dplyr::group_by(home_code) %>% 
  dplyr::summarise(first_case_date = min(first_case_date)) 
  # tidyr::crossing(tibble(outbreak = c(0, 1)))

residents_episodes <- tline %>% 
  filter(rday==1)  %>% 
  left_join(home_first_case) %>%
  mutate(outbreak = dplyr::case_when(
    date >= first_case_date ~ 1L,
    date < first_case_date ~ 0L,
    TRUE ~ 0L
  ))  %>% 
  group_by(resident_id, home_code, dob, gender, 
           status, home_type, user_type2,
           susceptible_symptomatic, 
           susceptible_confirmed,
           outbreak) %>% 
  summarise(entry_date = min(date),
            exit_date = max(date+1),
            resident_days = sum(rday),
            susceptible_symptomatic_days = sum(susceptible_symptomatic),
            susceptible_confirmed_days = sum(susceptible_confirmed)) %>% 
  mutate(date1 = as.numeric( entry_date - date_min),
         date2 = as.numeric(exit_date - date_min),
         ageg = cut_age_denary(compute_age(dob, date_min), age.min = 75, age.max = 95)) %>% 
  mutate(symptomatic = -susceptible_symptomatic+1,
         confirmed = -susceptible_confirmed+1,
         symptomatic_confirmed = (-susceptible_symptomatic+1)*(-susceptible_confirmed+1),
         date2 = if_else(date1 == date2, date2 + 1, date2)) %>% 
  mutate(covid_status = case_when(
    symptomatic==0 & confirmed == 0 ~ "Uninfected",
    symptomatic==1 & confirmed == 0 ~ "Symptomatic (not confirmed)",
    symptomatic==0 & confirmed == 1 ~ "Asymptomatic confirmed",
    symptomatic==1 & confirmed == 1 ~ "Symptomatic confirmed"
  )) %>% 
  mutate(covid_status = factor(covid_status, 
                               levels = c("Uninfected", "Symptomatic (not confirmed)",
                                          "Asymptomatic confirmed", "Symptomatic confirmed")),
         ageg = cut_age_denary(compute_age(dob, date_min), age.min = 75, age.max = 95))   %>% 
  left_join(select(reference_homes, home_code, country, region_UK,
                   staff_to_bed_ratio, staff_to_bed_ratio_g5, carer_to_bed_ratio, bed_tot_category, 
                   beds, pct_occupancy, no_bedrooms, uk_imd_england_quintile,
                   occ_bedroom_ratio, occ_bedroom_ratio_g5, occ_bedroom_ratio_g6)) %>% 
  group_by(resident_id) %>% 
  mutate(death_status = if_else(
    date1 == max(date1),
    as.integer(status == "Deceased"),
    0L
  )) %>% 
  ungroup()  


residents_episodes <- dplyr::mutate(
  residents_episodes,
  covid_status_outbreak = as.factor(case_when(
    covid_status == "Uninfected" & outbreak == 0 ~ "0 Uninfected (other home)",
    covid_status == "Symptomatic (not confirmed)" &
      outbreak==0 ~ "1 Symptomatic not confirmed  (other home)",
    covid_status == "Uninfected" & outbreak == 1 ~ "2 Uninfected (outbreak home)",
    covid_status == "Symptomatic (not confirmed)" &
      outbreak==1 ~ "3 Symptomatic not confirmed  (outbreak home)",
    covid_status == "Asymptomatic confirmed" ~ "4 Confirmed asymptomatic",
    covid_status == "Symptomatic confirmed" ~ "5 Confirmed symptomatic"
  )))

residents_episodes$covid_status_outbreak_digit <- as.factor(
  as.numeric(residents_episodes$covid_status_outbreak)-1)
residents_episodes <- bind_cols(
  residents_episodes,
  as_tibble(model.matrix(~covid_status_outbreak_digit, residents_episodes)[ ,-1])
) 

residents_episodes_short <- residents_episodes %>% 
  filter(exit_date > date_min_cox_mortality) %>% 
  mutate(date1 = if_else(
    entry_date >= date_min_cox_mortality,
    date1,
    as.numeric( date_min_cox_mortality - date_min),
  ))


# CARE HOME AGGREGATES
home_total_confirmed_DAT <- filter(residents_overview, !is.na(covid_first_confirmed)) %>% 
  filter(between(covid_first_confirmed, date_min_tallies, date_max_tallies)) %>% 
  group_by(home_code) %>% 
  summarise(DAT_confirmed = tidyr::replace_na(n_distinct(resident_id), 0))
home_total_confirmed_CT <- new_cases %>% group_by(home_code) %>% 
  summarise(CT_confirmed = sum(tidyr::replace_na(new_confirmed_home, 0) + 
                                 tidyr::replace_na(new_confirmed_hospital, 0)))

res_counts <- residents_overview %>% 
  group_by(home_code) %>% 
  summarise(unique_residents = n_distinct(resident_id),
            total_rdays = sum(resident_days))

desc_homes <- reference_homes %>% 
  left_join(res_counts, by = "home_code") %>%
  mutate(Scope = paste("FSHCG", country)) %>% 
  group_by(Scope) %>% 
  summarise(., 
            `Total homes` = n_distinct(home_code),
            `Total beds` = sum(beds),
            `Total contract beds` = sum(contract_beds, na.rm = T),
            `Total residents (excl. contract beds)` = sum(unique_residents, na.rm = T))

desc_national <- tibble(
  Scope = c("England", "Scotland (2017)", "Northern Ireland"),
  `Total homes` = c(9400, 1142, 483),
  `Total beds` = c(45000, 40926, 16095),
  `Total contract beds` = NA_integer_,
  `Total residents` = c(NA, 35989, NA)
)

home_total_confirmed <- distinct(reference_homes, home_code, home_name_clickview, 
                                 country, region_UK, staff_to_bed_ratio, carer_to_bed_ratio, 
                                 bed_tot_category, beds, pct_occupancy, no_bedrooms, 
                                 occ_bedroom_ratio, occ_bedroom_ratio_g5, occ_bedroom_ratio_g6,
                                 younger_person, residential_general, residential_dementia,
                                 nursing_general,nursing_dementia) %>% 
  left_join(res_counts, by = "home_code") %>% 
  left_join(home_total_confirmed_CT) %>% 
  left_join(home_total_confirmed_DAT) %>% 
  mutate(CT_confirmed = tidyr::replace_na(CT_confirmed, 0),
         DAT_confirmed = tidyr::replace_na(DAT_confirmed, 0))

home_zero_confirmed <- home_total_confirmed %>% 
  group_by(region_UK) %>% 
  summarise(`Total homes` = n(),
            zero_datix = sum(DAT_confirmed == 0),
            pct_datix = sum(DAT_confirmed == 0)/n(),
            zero_CT = sum(CT_confirmed == 0) ,
            pct_CT =  sum(CT_confirmed == 0)/n()) %>% 
  arrange(-pct_datix)

desc_homes <- bind_rows(desc_homes, desc_national) 
```

```{r km_objects}

residents_ct <- tibble(date = seq(date_min, date_max_tallies, 1)) %>% 
  left_join(select(new_cases, date, home_code, 
                     new_confirmed_home, new_confirmed_hospital,
                     new_symptomatic_home, new_symptomatic_hospital,
                     new_deaths_home, new_deaths_hospital)) %>% 
  filter(!is.na(home_code)) %>% 
  left_join(distinct(reference_homes, home_code, home_name_datix, postcode, 
                     staff_total, nursing_dementia, nursing_general, 
                     residential_dementia, residential_general, younger_person)) %>% 
  left_join(select(reference_geography, postcode, region_UK)) %>% 
  left_join(occupancy_interpolated) %>% 
  mutate(new_symptomatic = tidyr::replace_na(new_symptomatic_home, 0) + 
           tidyr::replace_na(new_symptomatic_hospital, 0),
         new_confirmed = tidyr::replace_na(new_confirmed_home, 0) + 
           tidyr::replace_na(new_confirmed_hospital, 0),
         new_deaths = tidyr::replace_na(new_deaths_home, 0)  +
           tidyr::replace_na(new_deaths_hospital, 0)
         ) %>%   
  arrange(home_code, date) %>% 
  group_by(home_code) %>% 
  mutate(I_symptomatic = total_cases_in_home(occupancy, new_symptomatic, date),
         I_confirmed = total_cases_in_home(occupancy, new_confirmed, date)) %>% 
  ungroup()
 

km_ct_residents_deaths <- residents_ct %>% 
  group_by(date) %>% 
  summarise(
    deaths = sum(new_deaths),
    occupancy = sum(occupancy)
  ) %>% 
  km_ct_estimator(df = ., t = date, d = deaths, 
                  pop = occupancy, subtract_cases = FALSE, overwrite = TRUE) %>% 
  ungroup() %>% 
  mutate(
    St_max = S_t^exp(1.96*S_t_SElog),
    St_min = S_t^exp(-1.96*S_t_SElog),
    event = "Covid-19-related death"
  )

km_ct_residents_confirmed <- residents_ct %>% 
  group_by(date) %>% 
  summarise(
    confirmed = sum(new_confirmed),
    I_confirmed = round(sum(I_confirmed)),
    occupancy = sum(occupancy)
  ) %>% 
  km_ct_estimator(df = ., t = date, d = confirmed, 
                  pop = (occupancy - I_confirmed), subtract_cases = FALSE, overwrite = TRUE) %>% 
  ungroup() %>% 
  mutate(
    St_max = S_t^exp(1.96*S_t_SElog),
    St_min = S_t^exp(-1.96*S_t_SElog),
    event = "Confirmed infection"
  )

km_ct_residents_symp <- residents_ct %>% 
  group_by(date) %>% 
  summarise(
    symptomatic = sum(new_symptomatic),
    I_symptomatic = round(sum(I_symptomatic)),
    occupancy = sum(occupancy)
  ) %>% 
  km_ct_estimator(df = ., t = date, d = symptomatic, 
                  pop = (occupancy - I_symptomatic), subtract_cases = FALSE, overwrite = TRUE) %>% 
  ungroup() %>% 
  mutate(
    St_max = S_t^exp(1.96*S_t_SElog),
    St_min = S_t^exp(-1.96*S_t_SElog),
    event = "Symptomatic case"
  )

staff_ct <- tibble(date = seq(date_min, date_max_tallies, 1)) %>% 
  left_join(distinct(new_cases, date, home_code, 
                     new_colleague_confirmed, new_colleague_symptomatic)) %>% 
  filter(!is.na(home_code)) %>% 
  left_join(distinct(reference_homes, home_code, home_name_datix, postcode, staff_total, nursing_dementia, nursing_general, residential_dementia, residential_general, younger_person)) %>% 
  left_join(select(reference_geography, postcode, region_UK))  %>% 
  arrange(date) %>% 
  group_by(home_code) %>% 
  mutate(
    new_colleague_confirmed = tidyr::replace_na(new_colleague_confirmed, 0),
    new_colleague_symptomatic = tidyr::replace_na(new_colleague_symptomatic, 0)
    ) %>% 
  mutate(I_symptomatic = total_cases_in_home(staff_total, new_colleague_symptomatic, date),
         I_confirmed = total_cases_in_home(staff_total, new_colleague_confirmed, date)) %>% 
  ungroup()

km_staff_symptomatic <- staff_ct %>% 
  group_by(date) %>% 
  summarise(
    symptomatic = sum(new_colleague_symptomatic),
    I_symptomatic = round(sum(I_symptomatic)),
    staff_total = sum(staff_total)
  ) %>% 
  km_ct_estimator(., t=date, d=symptomatic, pop=(staff_total-I_symptomatic),
                  subtract_cases = FALSE, overwrite = TRUE) %>% 
  ungroup() %>% 
  mutate(
    St_max = S_t^exp(1.96*S_t_SElog),
    St_min = S_t^exp(-1.96*S_t_SElog),
    event = "Symptomatic case"
  )

km_staff_confirmed <- staff_ct %>% 
  group_by(date) %>% 
  summarise(
    confirmed = sum(new_colleague_confirmed),
    I_confirmed = round(sum(I_confirmed)),
    staff_total = sum(staff_total)
  ) %>% 
  km_ct_estimator(., t=date, d=confirmed, pop=(staff_total-I_confirmed),
                  subtract_cases = FALSE, overwrite = TRUE) %>% 
  ungroup() %>% 
  mutate(
    St_max = S_t^exp(1.96*S_t_SElog),
    St_min = S_t^exp(-1.96*S_t_SElog),
    event = "Confirmed infection"
  )

desc_staff <- list()
desc_staff$total_staff <- reference_homes %>% filter(home_code %in% unique(residents_overview$home_code)) %>% .$staff_total %>% sum()

desc_staff$CT_symptomatic_total <- sum(new_cases$new_colleague_symptomatic, na.rm = T)
desc_staff$CT_symptomatic_denom <- sum(km_staff_symptomatic$n_t)

desc_staff[paste0(
  "CT_symptomatic_p", c("", "_lower", "_upper")
)] <- epitools::binom.exact(
  desc_staff$CT_symptomatic_total,
  desc_staff$total_staff)[c("proportion", "lower", "upper")] *100

desc_staff[paste0(
  "CT_symptomatic_IR", c("", "_lower", "_upper")
)] <- epitools::pois.exact(
  desc_staff$CT_symptomatic_total,
  desc_staff$CT_symptomatic_denom)[c("rate", "lower", "upper")] *100000

desc_staff$CT_confirmed_total <- sum(new_cases$new_colleague_confirmed, na.rm = T)
desc_staff$CT_confirmed_denom <- sum(km_staff_confirmed$n_t)
desc_staff[paste0(
  "CT_confirmed_p", c("", "_lower", "_upper")
)] <- epitools::binom.exact(
  desc_staff$CT_confirmed_total,
  desc_staff$total_staff)[c("proportion", "lower", "upper")] *100

desc_staff[paste0(
  "CT_confirmed_IR", c("", "_lower", "_upper")
)] <- epitools::pois.exact(
  desc_staff$CT_confirmed_total,
  desc_staff$CT_confirmed_denom)[c("rate", "lower", "upper")] *100000

```

```{r descriptives}
desc_residents <- list()
desc_residents$DAT_total_residents <- dplyr::n_distinct(residents_overview$resident_id)

#COUNTS
# This is estimated in validation.Rmd
desc_residents$CT_total_residents <- tline %>% 
  dplyr::filter(between(date, date_min_tallies, date_max_tallies) & rday == 1) %>% summarise(n = round(dplyr::n_distinct(resident_id) * 1.123865 + .49)) %>% .$n  

desc_residents$CT_total_residents_england <- tline %>% 
  dplyr::inner_join(select(filter(reference_homes, country == "England"), home_code)) %>%
  dplyr::filter(between(date, date_min_tallies, date_max_tallies) & rday == 1) %>%
  summarise(n = round(dplyr::n_distinct(resident_id) * 1.087621 + .49)) %>% .$n   

desc_residents$CT_total_symptomatic <- sum(new_cases$new_symptomatic_home, na.rm=T) + 
  sum(new_cases$new_symptomatic_hospital, na.rm=T)
desc_residents$CT_total_symptomatic_denom <- sum(km_ct_residents_symp$n_t)
desc_residents[paste0(
  "CT_p_symptomatic", c("", "_lower", "_upper")
)] <- epitools::binom.exact(desc_residents$CT_total_symptomatic,
                            desc_residents$CT_total_residents)[
                              c("proportion", "lower", "upper")
                            ] * 100

desc_residents[paste0(
  "CT_IR_symptomatic", c("", "_lower", "_upper")
)] <- epitools::pois.exact(desc_residents$CT_total_symptomatic,
                            desc_residents$CT_total_symptomatic_denom)[
                              c("rate", "lower", "upper")
                            ] * 100000

desc_residents$CT_total_confirmed <-  sum(new_cases$new_confirmed_home, na.rm = T) + sum(new_cases$new_confirmed_hospital, na.rm = T)
desc_residents$CT_total_confirmed_denom <- sum(km_ct_residents_confirmed$n_t)
 
desc_residents[paste0(
  "CT_p_confirmed", c("", "_lower", "_upper")
)] <- epitools::binom.exact(desc_residents$CT_total_confirmed,
                            desc_residents$CT_total_residents)[
                              c("proportion", "lower", "upper")
                            ] * 100 

desc_residents[paste0(
  "CT_IR_confirmed", c("", "_lower", "_upper")
)] <- epitools::pois.exact(desc_residents$CT_total_confirmed,
                            desc_residents$CT_total_confirmed_denom)[
                              c("rate", "lower", "upper")
                            ] * 100000

desc_residents$CT_total_cdeath <-  sum(new_cases$new_deaths_home, na.rm = T) + sum(new_cases$new_deaths_hospital, na.rm = T)
desc_residents$CT_total_cdeath_denom <- sum(km_ct_residents_deaths$n_t)
 
desc_residents[paste0(
  "CT_p_cdeath", c("", "_lower", "_upper")
)] <- epitools::binom.exact(desc_residents$CT_total_cdeath,
                            desc_residents$CT_total_residents)[
                              c("proportion", "lower", "upper")
                            ] * 100 

desc_residents[paste0(
  "CT_IR_cdeath", c("", "_lower", "_upper")
)] <- epitools::pois.exact(desc_residents$CT_total_cdeath,
                            desc_residents$CT_total_cdeath_denom)[
                              c("rate", "lower", "upper")
                            ] * 100000
    
#INCIDENT REPORTS
desc_residents$unique_residents_incidents <- dplyr::n_distinct(incidents$resident_id)

desc_residents$DAT_total_symptomatic <- n_distinct(filter(incidents, !is.na(covid_first_symptomatic))$resident_id)
desc_residents$DAT_total_symptomatic_denom <- sum(residents_overview$susceptible_symptomatic_days)
desc_residents[paste0(
  "DAT_p_symptomatic", c("", "_lower", "_upper")
)] <- epitools::binom.exact(desc_residents$DAT_total_symptomatic,
                            desc_residents$DAT_total_residents)[
                              c("proportion", "lower", "upper")
                            ] * 100
desc_residents[paste0(
  "DAT_IR_symptomatic", c("", "_lower", "_upper")
)] <- epitools::pois.exact(desc_residents$DAT_total_symptomatic,
                            desc_residents$DAT_total_symptomatic_denom)[
                              c("rate", "lower", "upper")
                            ] * 100000
 
desc_residents$total_tests <- nrow(dplyr::filter(incidents, covid_tested == 1))
desc_residents$unique_residents_tested <- dplyr::filter(incidents, covid_tested == 1) %>% 
  dplyr::summarise(n = n_distinct(resident_id)) %>% .$n
desc_residents$unique_residents_test_result <- dplyr::filter(incidents, !is.na(covid_test_result)) %>% 
  dplyr::summarise(n = n_distinct(resident_id)) %>% .$n
desc_residents$unique_residents_test_result_positive <- dplyr::filter(incidents, covid_test_result == 1) %>%  
  dplyr::summarise(n = n_distinct(resident_id)) %>% .$n

desc_residents$DAT_total_confirmed_denom <- sum(residents_overview$susceptible_confirmed_days)
desc_residents[paste0(
  "DAT_p_confirmed", c("", "_lower", "_upper")
)] <- epitools::binom.exact(desc_residents$unique_residents_test_result_positive,
                            desc_residents$DAT_total_residents)[
                              c("proportion", "lower", "upper")
                            ] * 100

desc_residents[paste0(
  "DAT_IR_confirmed", c("", "_lower", "_upper")
)] <- epitools::pois.exact(desc_residents$unique_residents_test_result_positive,
                            desc_residents$DAT_total_confirmed_denom)[
                              c("rate", "lower", "upper")
                            ] * 100000


# CASE FATALITY AND RELATIVE RISK

desc_residents$DAT_total_deaths <- sum(residents_overview$status == "Deceased")
desc_residents$total_denom <- sum(residents_overview$resident_days)
desc_residents[paste0(
  "DAT_p_death",  c("", "_lower", "_upper")
)] <- epitools::binom.exact(
  desc_residents$DAT_total_deaths,
  desc_residents$DAT_total_residents
)[c("proportion", "lower", "upper")] *100

desc_residents[paste0(
  "DAT_IR_death",  c("", "_lower", "_upper")
)] <- epitools::pois.exact(
  desc_residents$DAT_total_deaths,
  desc_residents$total_denom
)[c("rate", "lower", "upper")] * 100000


desc_residents$DAT_CFR <- residents_overview %>% 
  filter(confirmed == 1) %>% 
  summarise(n = n(),
            y = sum(status == "Deceased"))

desc_residents$DAT_BFR <- residents_overview %>%
  filter(confirmed != 1) %>%
  summarise(n = n(),
            y = sum(status == "Deceased"))

desc_residents$DAT_CFR_RR <- relative_risk(
  desc_residents$DAT_CFR$y, 
  desc_residents$DAT_CFR$n - desc_residents$DAT_CFR$y, 
  desc_residents$DAT_BFR$y, 
  desc_residents$DAT_BFR$n - desc_residents$DAT_BFR$y)
 
desc_residents$DAT_CFR_RR_SE <- relative_risk_SE(
  desc_residents$DAT_CFR$y, 
  desc_residents$DAT_CFR$n - desc_residents$DAT_CFR$y, 
  desc_residents$DAT_BFR$y, 
  desc_residents$DAT_BFR$n - desc_residents$DAT_BFR$y)

desc_residents$DAT_CFR_RR_lower <- exp(log(desc_residents$DAT_CFR_RR) - 1.96 * desc_residents$DAT_CFR_RR_SE)
desc_residents$DAT_CFR_RR_upper <- exp(log(desc_residents$DAT_CFR_RR) + 1.96 * desc_residents$DAT_CFR_RR_SE)

desc_residents[paste0(
  "DAT_CFR_rate", c("", "_lower", "_upper")
)] <- epitools::binom.exact(
  desc_residents$DAT_CFR$y,
  desc_residents$DAT_CFR$n
)[c("proportion", "lower", "upper")] *100

desc_residents[paste0(
  "DAT_BFR_rate", c("", "_lower", "_upper")
)] <- epitools::binom.exact(
  desc_residents$DAT_BFR$y,
  desc_residents$DAT_BFR$n
)[c("proportion", "lower", "upper")] *100


### Homes
desc_residents$total_homes <- n_distinct(home_total_confirmed$home_code)
desc_residents$CT_zero_case <- sum(home_total_confirmed$CT_confirmed == 0)
desc_residents$DAT_zero_case <- sum(home_total_confirmed$DAT_confirmed == 0)


## OUTBREAK HOMES 
desc_residents_outbreak_only <- list()
desc_residents_outbreak_only$outbreak_homes <- unique(
  c(home_total_confirmed$home_code[home_total_confirmed$CT_confirmed != 0],
  distinct(filter(new_cases, tidyr::replace_na(new_deaths_hospital, 0) > 0 |
                    tidyr::replace_na(new_deaths_home, 0)>0), home_code)$home_code,
  distinct(filter(residents_overview, confirmed == 1), home_code)$home_code)
)



desc_residents$DAT_BFR_outbreak_homes <- residents_overview %>%
  filter(home_code %in% desc_residents_outbreak_only$outbreak_homes & confirmed != 1) %>%
  summarise(n = n(),
            y = sum(status == "Deceased"))

desc_residents$DAT_BFR_other_homes <- residents_overview %>%
  filter((!home_code %in% desc_residents_outbreak_only$outbreak_homes) & confirmed != 1) %>%
  summarise(n = n(),
            y = sum(status == "Deceased"))

desc_residents$DAT_BFR_outbreak_homes$RR <- relative_risk(
  desc_residents$DAT_BFR_outbreak_homes$y,
  desc_residents$DAT_BFR_outbreak_homes$n - desc_residents$DAT_BFR_outbreak_homes$y,
  desc_residents$DAT_BFR_other_homes$y, 
  desc_residents$DAT_BFR_other_homes$n - desc_residents$DAT_BFR_other_homes$y)

desc_residents$DAT_BFR_outbreak_homes$RR_SE <- relative_risk_SE(
  desc_residents$DAT_BFR_outbreak_homes$y, 
  desc_residents$DAT_BFR_outbreak_homes$n - desc_residents$DAT_BFR_outbreak_homes$y,
  desc_residents$DAT_BFR_other_homes$y, 
  desc_residents$DAT_BFR_other_homes$n - desc_residents$DAT_BFR_other_homes$y)

desc_residents$DAT_BFR_outbreak_homes$RR_lower <- exp(
  log(desc_residents$DAT_BFR_outbreak_homes$RR) - 
    1.96*desc_residents$DAT_BFR_outbreak_homes$RR_SE
)
desc_residents$DAT_BFR_outbreak_homes$RR_upper <- exp(
  log(desc_residents$DAT_BFR_outbreak_homes$RR) + 
    1.96*desc_residents$DAT_BFR_outbreak_homes$RR_SE
)


desc_residents_outbreak_only$CT_total_beds <- beds %>% 
  filter(year == 2020 & home_code %in% desc_residents_outbreak_only$outbreak_homes) %>% 
  summarise(beds = sum(beds),
            contract_beds = sum(contract_beds))
  
desc_residents_outbreak_only$CT_total_residents <- residents_overview %>% 
  dplyr::filter(home_code %in% desc_residents_outbreak_only$outbreak_homes) %>% 
  dplyr::summarise(total_residents = round(dplyr::n_distinct(resident_id)* 1.122205 + .49)) %>% 
  .$total_residents


desc_residents_outbreak_only$CT_total_confirmed <- new_cases %>% 
  filter(home_code %in% desc_residents_outbreak_only$outbreak_homes) %>% 
  summarise(n = sum(new_confirmed_home, na.rm = T) + sum(new_confirmed_hospital, na.rm = T)) %>% 
  .$n

desc_residents_outbreak_only$CT_total_symptomatic <- new_cases %>% 
  filter(home_code %in% desc_residents_outbreak_only$outbreak_homes) %>% 
  summarise(n = sum(new_symptomatic_home, na.rm = T) + sum(new_symptomatic_hospital, na.rm = T)) %>% 
  .$n

desc_residents_outbreak_only$CT_total_confirmed_denom <- residents_ct %>% 
  filter(home_code %in% desc_residents_outbreak_only$outbreak_homes) %>% 
  summarise(n = sum(occupancy - I_confirmed)) %>% 
  .$n

desc_residents_outbreak_only[paste0(
  "CT_p_confirmed", c("", "_lower", "_upper")
)] <- epitools::binom.exact(desc_residents_outbreak_only$CT_total_confirmed,
                            desc_residents_outbreak_only$CT_total_residents)[
                              c("proportion", "lower", "upper")
                              ] * 100 

desc_residents_outbreak_only[paste0(
  "CT_IR_confirmed", c("", "_lower", "_upper")
)] <- epitools::pois.exact(desc_residents_outbreak_only$CT_total_confirmed,
                           desc_residents_outbreak_only$CT_total_confirmed_denom)[
                             c("rate", "lower", "upper")
                             ] * 100000


desc_residents_outbreak_only$CT_total_symptomatic <-  new_cases %>% 
  filter(home_code %in% desc_residents_outbreak_only$outbreak_homes) %>% 
  summarise(n = sum(new_symptomatic_home, na.rm = T) + sum(new_symptomatic_hospital, na.rm = T)) %>% 
  .$n

desc_residents_outbreak_only$CT_total_symptomatic_denom <- residents_ct %>% 
  filter(home_code %in% desc_residents_outbreak_only$outbreak_homes) %>% 
  summarise(n = sum(occupancy - I_symptomatic)) %>% 
  .$n

desc_residents_outbreak_only[paste0(
  "CT_p_symptomatic", c("", "_lower", "_upper")
)] <- epitools::binom.exact(desc_residents_outbreak_only$CT_total_symptomatic,
                            desc_residents_outbreak_only$CT_total_residents)[
                              c("proportion", "lower", "upper")
                            ] * 100
desc_residents_outbreak_only[paste0(
  "CT_IR_symptomatic", c("", "_lower", "_upper")
)] <- epitools::pois.exact(desc_residents_outbreak_only$CT_total_symptomatic,
                            desc_residents_outbreak_only$CT_total_symptomatic_denom)[
                              c("rate", "lower", "upper")
                            ] * 100000
 
desc_residents_outbreak_only$CT_total_cdeath <-  sum(new_cases$new_deaths_home, na.rm = T) + sum(new_cases$new_deaths_hospital, na.rm = T)
desc_residents_outbreak_only$CT_total_cdeath_denom <- residents_ct %>% 
  filter(home_code %in% desc_residents_outbreak_only$outbreak_homes) %>% 
  summarise(n = sum(occupancy)) %>% 
  .$n

desc_residents_outbreak_only[paste0(
  "CT_p_cdeath", c("", "_lower", "_upper")
)] <- epitools::binom.exact(desc_residents_outbreak_only$CT_total_cdeath,
                            desc_residents_outbreak_only$CT_total_residents)[
                              c("proportion", "lower", "upper")
                            ] * 100 

desc_residents_outbreak_only[paste0(
  "CT_IR_cdeath", c("", "_lower", "_upper")
)] <- epitools::pois.exact(desc_residents_outbreak_only$CT_total_cdeath,
                            desc_residents_outbreak_only$CT_total_cdeath_denom)[
                              c("rate", "lower", "upper")
                            ] * 100000

```

```{r captions}
## TABLES
table_nums <- captioner::captioner(prefix = "Table")

incidence_CT_residents <- table_nums(
  name = "incidence_CT_residents",
  caption =  paste0("Cumulative incidence and rate of SARS-CoV-2 infections in residents according to FSHCG manager counts (", format(date_min, "%e %b %Y"), "-", format(date_max, "%e %b %Y"), ")"))
supp_epi_CT_oubreak_only <- table_nums(
  name = "incidence_CT_staff",
  caption =  paste0("Cumulative incidence and rate of SARS-CoV-2 infections among staff according to FSHCG manager counts (", format(date_min, "%e %b %Y"), "-", format(date_max, "%e %b %Y"), ")"))
tab_resident_descriptives <- table_nums(
  name = "tab_resident_descriptives",
  caption = paste0("Characteristics of FSHCG private bed residents by care home type, sex, age, region and status on study exit (", format(date_min, "%e %b %Y"), "-", format(date_max, "%e %b %Y"), ")"))
tab_CFR_age_sex <- table_nums(
  name = "tab_CFR_age_sex",
  caption =  paste0("All-cause case-fatality rates by age and sex among private residents (n=", 
  formatbm(dplyr::n_distinct(residents_overview$resident_id)),
  "; ", format(date_min, "%e %b %Y"), "-", format(date_max, "%e %b %Y"), ")"))
tab_CoxPH_confirmed <- table_nums(
  name = "tab_CoxPH_confirmed",
  caption =  paste0("Risk factors for confirmed infection in private residents: hazard ratios (HR) from a Cox proportional hazards model (n=", 
  formatbm(dplyr::n_distinct(residents_overview$resident_id)),
  ")"))
tab_CoxPH_death <- table_nums(
  name = "tab_CoxPH_death",
  caption =  paste0("Risk factors for all-cause mortality in private residents of care homes with and without Covid-19 outbreaks: hazard ratios (HR) from a Cox proportional hazards model (n=", 
  formatbm(dplyr::n_distinct(residents_episodes$resident_id)),
  ", ", format(date_min, "%e %b %Y"), "-", format(date_max, "%e %b %Y"), ")"))
tab_attributable_deaths <- table_nums(
  name = "tab_attributable_deaths",
  caption =  paste0("Model-based estimates of attributable death in private residents of care homes with and without Covid-19 outbreaks (n=", 
  formatbm(dplyr::n_distinct(residents_episodes$resident_id)),
  ", ", format(date_min, "%e %b %Y"), "-", format(date_max, "%e %b %Y"), ")"))


supp_epi_DAT <- table_nums(
  name = "supp_epi_DAT",
  caption =  paste0("Incidence proportions and rates of SARS-CoV-2 infections amongst residents according to Datix incident reports (", format(date_min, "%e %b %Y"), "-", format(date_max, "%e %b %Y"), ")"))

tab_national_descriptives <- table_nums(
  name = "tab_national_descriptives",
  caption = "Total homes, beds, contract beds, and residents within FSHCG and nationwide")

tab_zero_cases <- table_nums(
  name = "tab_zero_cases",
  caption = paste0("Number and proportion of homes without confirmed cases by UK region (", format(date_min_tallies, "%e %b %Y"), "-", format(date_max_tallies, "%e %b %Y"), ")")
)

## FIGURES
fig_nums <- captioner(prefix = "Figure")

fig_study_diagram <- fig_nums(
  name = "fig_study_diagram",
  caption = paste0("Study overview: location of FSHCG care homes and diagram of data sources")
)

fig_KM_CT_plots <- fig_nums(
  name = "fig_KM_CT_plots",
  caption = paste0("Kaplan-Meier estimates of the cumulative incidence of symptomatic cases, confirmed infections and COVID-related deaths in (A) residents (n=",   formatbm(desc_residents$CT_total_residents),
  ") and (B) care home staff (n=",   formatbm(desc_staff$total_staff),
  ") according to FSHCG outbreak surveillance counts (", format(date_min_tallies, "%e %b %Y"), "-", format(date_max_tallies, "%e %b %Y"), ")"))

fig_KM_mortality <- fig_nums(
  "fig_KM_mortality",
  caption = paste0("Kaplan-Meier estimates of resident (n=",
  formatbm(dplyr::n_distinct(residents_overview$resident_id)),
  ") survival by SARS-COV-2 case type"))

```


```{r period_prevalence, message=F}
# Cumulative sample counts, directly standardised for
# 11 May to 24 May
# 25 May to 7 June

england_results <- list(
  date_min = as.Date("2020-05-11"),
  date_max = as.Date("2020-06-07"),
  cis_confirmed = 35,
  cis_person_days = 483259
)

england_results$FSHC_confirmed <- new_cases %>% 
  filter(between(date, england_results$date_min, england_results$date_max)) %>% 
  inner_join(filter(reference_homes, country == "England")) %>% 
  summarise(
    n = sum(new_confirmed_home, na.rm = T) + sum(new_confirmed_hospital, na.rm = T)
  ) %>% 
  .$n

england_results$FSHC_resident_days <- filter(km_ct_residents_confirmed,
  between(date, england_results$date_min, england_results$date_max)) %>% 
  summarise(n = sum(n_t, na.rm = T) ) %>% 
  .$n

england_results$results <- epitools::rateratio.wald(
  c(england_results$cis_confirmed,
    england_results$FSHC_confirmed,
    england_results$cis_person_days,
    england_results$FSHC_resident_days))
```

# Abstract

**Background** Rates of Covid-19 infection have declined in many countries, but outbreaks persist in care home residents who are at high risk of severe outcomes. Epidemiological data from care homes are scarce. We used population-level active surveillance to estimate incidence of, and risk factors for Covid-19, and attributable mortality in care home residents.

**Methods:** Cohort study using individual-level electronic health records from 8,713 residents and daily counts of infection for `r formatbm(desc_residents$CT_total_residents)` residents and `r formatbm(desc_staff$total_staff)` staff across `r dplyr::n_distinct(residents$home_code)` UK care homes. We modelled risk factors for infection and mortality using Cox proportional hazards and estimated attributable fractions.

**Findings:** `r formatbm(desc_residents$CT_total_symptomatic)` residents developed Covid-19 symptoms (`r tbrounding(desc_residents$CT_p_symptomatic)`% [95% confidence interval: `r tbrounding(desc_residents$CT_p_symptomatic_lower)`%; `r tbrounding(desc_residents$CT_p_symptomatic_upper)`%]), while `r formatbm(desc_residents$CT_total_confirmed)` residents (`r tbrounding(desc_residents$CT_p_confirmed)`% [`r tbrounding(desc_residents$CT_p_confirmed_lower)`%; `r tbrounding(desc_residents$CT_p_confirmed_upper)`%]) and `r formatbm(desc_staff$CT_confirmed_total)` staff (`r tbrounding(desc_staff$CT_confirmed_p)`% [`r tbrounding(desc_staff$CT_confirmed_p_lower)`%; `r tbrounding(desc_staff$CT_confirmed_p_upper)`%]) had laboratory confirmed infections. Confirmed infection incidence in residents and staff respectively was `r tbrounding(desc_residents$CT_IR_confirmed)` [`r tbrounding(desc_residents$CT_IR_confirmed_lower)`; `r tbrounding(desc_residents$CT_IR_confirmed_upper)`] and `r tbrounding(desc_staff$CT_confirmed_IR)` [`r tbrounding(desc_staff$CT_confirmed_IR_lower)`; `r tbrounding(desc_staff$CT_confirmed_IR_upper)`] per 100,000 person-days. `r length(desc_residents_outbreak_only$outbreak_homes)`/`r desc_residents$total_homes` (`r tbrounding(length(desc_residents_outbreak_only$outbreak_homes)/desc_residents$total_homes*100)`%) care homes had at least one Covid-19 infection or death. Lower staffing ratios and higher occupancy rates were independent risk factors for infection. 

`r formatbm(desc_residents$DAT_total_deaths)` all-cause deaths occurred in `r formatbm(desc_residents$DAT_total_residents)` (`r tbrounding(desc_residents$DAT_p_death)`% [`r tbrounding(desc_residents$DAT_p_death_lower)`%; `r tbrounding(desc_residents$DAT_p_death_upper)`%]) residents. `r desc_residents$DAT_CFR$y` deaths occured in `r desc_residents$DAT_CFR$n` residents with confirmed infection (case-fatality rate: `r tbrounding(desc_residents$DAT_CFR_rate)`% [`r tbrounding(desc_residents$DAT_CFR_rate_lower)`%; `r tbrounding(desc_residents$DAT_CFR_rate_upper)`%]). Mortality in residents with no direct evidence of infection was 96% higher in care homes with at least one Covid-19 infection or death compared to care homes without (adjusted HR 1.9 [1.7; 2.2]). 33% of all-cause deaths were attributable to Covid-19 either through confirmed infection, or excess mortality.

**Interpretation:** 1 in 5 residents had symptoms of infection during the pandemic, but many cases were not tested. Higher occupancy and lower staffing levels increase infection risk. Disease control measures should integrate active surveillance and testing with fundamental changes in staffing and care home occupancy to protect staff and residents from infection.

**Funding:** Economic and Social Research Council [ES/V003887/1].


# Background 

Globally the number of cases of Covid-19 continues to increase, but cases in Europe have declined since April 2020,[@ECDC2020] following the introduction of lockdown measures.[@Hale2020] Although the incidence of infection in the general population in England is low (0.04%),[@cisbulletin2020] new infections persist, with substantially higher rates of infection reported in both care homes and hospitals.[@PHE2020] This raises the possibility that these settings represent a reservoir for transmission of infection back to the community. 

In the UK, there are an estimated 400,000 residents living in approximately 11,000 homes for the elderly.[@LaingBuisson2019] Care home residents are particularly vulnerable to Covid-19 due to their advanced age and high prevalence of comorbidity,[@Zhou2020] and their frequent exposure to infection through close contact with staff members, other residents and contaminated surfaces in the care home setting. At the peak of the pandemic, the number of deaths in care home residents was three-fold higher than the equivalent period in in 2019.[@onsDR2020] Care home staff also have higher aged-standardised rates of Covid-19 related mortality compared to other occupations.[@onsDR2020occ] National statistics suggests two-thirds of excess deaths recorded in care home residents in the last 6 months involved Covid-19,[@onsDR2020] but this is likely to be an underestimate because many residents were not tested. Understanding the proportion of excess deaths that can be directly and indirectly attributed to Covid-19 infection is important, to fully assess the impact of the pandemic on care homes.

The development of public health strategies to protect the public, residents and staff from Covid-19 requires knowledge of the burden of and risk factors for infection in care home residents and staff, linked to outcomes. However, there is no syndromic surveillance for infection in care homes in England, and widespread one-off testing for SARS-CoV-2 using reverse transcriptase polymerase chain reaction (RT-PCR) was not established for care home staff and residents until 11 May 2020.[@dhscTesting2020] Prior to this, testing was only available for care home residents or staff who were admitted to hospital, or as part of Public Health England’s (PHE) outbreak investigations which permitted a maximum of five tests per care home. Consequently national estimates of incidence and prevalence will substantially underestimate the burden of infection in care home residents and staff.


In the absence of cohort studies or active surveillance, outbreak investigations provide the most reliable estimates of the burden of infection and case-fatality.[@McMichael2020; @Dora2020] An estimated 44% of English care homes have had at least one outbreak, with a living systematic review[@Salcher-Konrad2020] reporting substantial variation in cumulative incidence of infection (0%-72%) and case fatality (0-34%) in care home residents. A major limitation of outbreak investigations is that follow-up is usually less than 30 days,[@Salcher-Konrad2020] and investigations are only conducted in settings in which outbreaks have been detected.  Understanding the proportion of care homes with undetected cases is crucial for policy decisions around the frequency of and justification for regular testing in care homes.

To our knowledge, there are no studies which have employed population-level active surveillance in care homes throughout this pandemic to measure outcomes of both suspected and confirmed infection in residents and staff. We analysed electronic health records from the Four Seasons Health Care Group, one of the UK’s largest independent provider of residential and nursing care, with the aim of identifying strategies to protect care home staff and residents from future waves of infection. Our objectives were to estimate incidence of and risk factors for infection and mortality in the following groups: (A) residents with no evidence of infection; (B) symptomatic residents; (C) asymptomatic residents with confirmed infection; and (D) symptomatic residents with confirmed infection. We also estimated mortality attributable to Covid-19.


# Methods

## Study population and setting

Staff or residents living and working in care homes for the elderly between `r format(date_min, "%e %B")` and `r format(date_max, "%e %B %Y")`, which were run by the Four Seasons Healthcare Group (FSHCG) were eligible for study inclusion. The FSHCG provides a combination of residential and nursing care (for residents with medical conditions), which is primarily state funded. Most residents are permanent, but a small proportion receive temporary (respite) care.

In 2020, there were 9,568 beds, representing 9% of all beds in England, Scotland and Northern Ireland (supplementary material 1). 90% of FSHCG care homes participated in the whole care home testing programme, implying that all staff and residents were tested for Covid-19 at least once between 11 May and 22 June 2020. 


## Data sources

Electronic record datasets collected by the FSHCG are primarily used for billing and monitoring care quality, but have also been used in research.[@Smith2020]

*Individual-level data*

The care home chain collects electronic health record data on all their residents except those occupying beds that are 'block contracted' to the local authority (855 beds). The dataset includes: dates of care home entry and exit, sex, date of birth, type of stay (residential/nursing) and care (general, dementia, elderly).  Individual-level data on incidents including infections are also reported via 'Datix' which records the residents name, care home identifier, incident date/time, date of birth, sex, Covid-19 symptoms, tests and test results, resident current location (home/hospital), and death. Information in Datix was used categorise residents’ infection status into four groups:  (A) residents with no evidence of infection (not tested and/or no symptoms); (B) symptomatic residents (symptoms and not tested or tested negative); (C) asymptomatic residents with confirmed infection (no symptoms but tested positive); and (D) symptomatic residents with confirmed infection (symptoms and tested positive) (supplementary material 1). The term 'confirmed' denoted a positive PCR test. Datix was also used to differentiate in-hospital and in care home deaths, and to identify Covid-19 related deaths. Individual level data on residents was linked to Datix reports by creating an index file based on a combination of forename, surname and the care home identifier (supplementary material 2).  1492/1880 (79%) of Datix reports were successfully linked. Individual-level records were available between `r format(date_min, "%e %B")` and `r format(date_max, "%e %B %Y")`. 

*Aggregate data*

On 24 March the care home chain introduced a new system to report Covid-19 cases and deaths. This required care home managers to report daily tallies in residents (new symptomatic cases, new confirmed infection in home, new confirmed infection in hospital, deaths related to Covid-19) and staff (symptomatic cases, new confirmed cases). Data on staff deaths were not extracted due to the small number of cases. Covid-19 related deaths were defined as death in a resident with confirmed infection or a death attributed to Covid-19 by the coroner.  The number of occupied beds in each care home was reported weekly. 

Care home characteristics (number of beds, region, nursing versus residential care) were collected from organisational data. We therefore extracted organisational data, individual-level data for 8713 residents and aggregate data for all care home staff and residents (`r fig_nums("fig_study_diagram", display = "cite")`).


```{r FSHCG_map, fig.width=3, fig.height=5, warning=F}
# reference_homes_lat_long <- reference_homes %>% 
#   dplyr::filter(home_code %in% home_inclusion) %>% 
#   dplyr::select(home_code, home_name_datix, postcode) %>% 
#   dplyr::left_join(reference_geography, by = "postcode")
#  
# care_homes_map <- ggplot(UK_country_region_sf)  +
#   geom_sf(size = 0.1) +
#   geom_sf_text(aes(label = ctry_reg_abb), fontface = "bold") +
#   theme_void() +
#   geom_point(data = reference_homes_lat_long, aes(y = latitude, x = longitude),
#              color = "#0099B4FF", size = .5) + # shape = 3
#   ggtitle(paste0(length(home_inclusion), " FSHCG care homes"))
# cairo_ps("map.ps", width = 3, height = 5)
# care_homes_map
# dev.off()
```

```{r study_diagram, fig.width=10, fig.height=5}
knitr::include_graphics("study_diagram.svg")
```

*Note:* `r paste(paste0(UK_country_region_sf$ctry_reg_abb, ": ", UK_country_region_sf$ctry_reg), collapse = "; ")`.

`r fig_nums("fig_study_diagram")`



## Risk factors for infection

Risk factors for infection included individual-level variables (age, sex, general or dementia care, residential versus nursing care) and care home characteristics (number of beds, care home occupancy and staff to bed ratio). Baseline care home occupancy was computed by averaging weekly occupancy in January-March 2020, before the first Covid-19 case, in order to calculate a ratio of baseline occupancy to the number of bedrooms. We also estimated the ratio of staff to beds. A care home outbreak was defined as at least one confirmed infection or Covid-19 related death. 

## Statistical analysis

*Infection in care home staff and residents*

Prevalence, incidence and cumulative incidence were calculated for residents and staff using the aggregate daily tallies. These were the trusted source of information used for national reporting of cases, and encompassed all residents and staff.[@CQC2020stats] Infection incidence was also estimated from Datix, but was subject to under-reporting (supplementary material 2). In order to calculate infection and death incidence, we estimated the total number of residents in each care home by extrapolating estimates of care home occupancy from the individual-level dataset (because dates of care home entry and exit were not available for 855 beds, supplementary material 1). Daily occupancy was inferred from the weekly report of bed occupancy using linear interpolation. The total number of residents at risk of infection was unknown, so it was approximated in a multiple decrements life table (supplementary material 1). The life table allowed us to compute Kaplan-Meier product limit estimators of the cumulative incidence of symptoms, confirmed infections, and Covid-19 related deaths by day. The rate ratio for care home versus community infections was estimated by contrasting the cumulative incidence for confirmed cases in England with estimates from a national household survey for the period `r format(england_results$date_min, "%e %B")`-`r format(england_results$date_max, "%e %B %Y")`.[@cisbulletin2020; @cisdata2020]


*Mortality, attributable mortality and risk factors*

Individual-level data were used to estimate rates of infection, all-cause mortality and case-fatality by age and gender in residents. Aggregate data were also used to estimate the crude rate of Covid-19 related mortality. Cox proportional hazards models were used to test the association between individual and organisational-level risk factors and confirmed infection. In order to investigate the relationship between Covid-19 infection and excess mortality, we assumed that residents in non-outbreak care homes had not been exposed to infection, and would therefore not experience excess Covid-19 related mortality.  We therefore compared all-cause mortality in residents with no evidence of infection (group A) in care homes with and without outbreaks.  

A Cox proportional hazards regression model tested the effect of individual and care home level risk factors on all-cause mortality, alongside the effect of the time-variant infection status (groups A-D) and care home outbreak status.  We estimated the attributable fraction of deaths for each infection category in care homes with and without outbreaks, taking the reference category as individuals with no direct evidence of infection (group A) in non-outbreak care homes. This fraction was obtained by using the model to predict the counterfactual mortality, then computing the attributable fraction within study.[@Samuelsen2008] Ninety-five percent confidence intervals for proportions and rates were computed from the exact Poisson and binomial limits.

Data were analysed in `R`3.5.0 using the `epitool`[@Aragon2020] and `survival`[@therneau2015] libraries. All computer syntax is available on an online repository.[@Dutey2020]


# Findings

## Cases of infection in residents and staff

The study included `r formatbm(desc_residents$CT_total_residents)` residents across England, Scotland and Northern Ireland and `r formatbm(desc_staff$total_staff)` staff. `r length(desc_residents_outbreak_only$outbreak_homes)`/`r desc_residents$total_homes` (`r tbrounding(length(desc_residents_outbreak_only$outbreak_homes)/desc_residents$total_homes*100)`%) care homes, totalling `r formatbm(desc_residents_outbreak_only$CT_total_residents)` residents, recorded at least one Covid-19 outbreak (including unconfirmed outbreaks) in either the individual-level or aggregate datasets.  The mean duration of follow-up for residents and staff was `r round(desc_residents$CT_total_cdeath_denom/desc_residents$CT_total_residents)` days and `r as.integer(date_max_tallies-date_min_tallies)` days respectively in the aggregate dataset. Mean and median duration of resident follow-up was `r round(mean(residents_overview$resident_days))` and `r median(residents_overview$resident_days)` days respectively in the individual-level dataset.

Symptoms of infection were recorded in  `r formatbm(desc_residents$CT_total_symptomatic)` residents based on the aggregate dataset, contributing to an overall cumulative incidence of `r tbrounding(desc_residents$CT_p_symptomatic)`% [`r tbrounding(desc_residents$CT_p_symptomatic_lower)`%; `r tbrounding(desc_residents$CT_p_symptomatic_upper)`%] or an incidence rate of `r tbrounding(desc_residents$CT_IR_symptomatic)` per 100,000 resident-days [`r tbrounding(desc_residents$CT_IR_symptomatic_lower)`; `r tbrounding(desc_residents$CT_IR_symptomatic_upper)`] (`r table_nums("incidence_CT_residents", display = "cite")`). An additional `r desc_residents$CT_total_confirmed` residents had a confirmed infection, of whom `r formatbm(sum(new_cases$new_confirmed_hospital, na.rm = T))` were diagnosed in hospital. The confirmed infection incidence proportion was `r tbrounding(desc_residents$CT_p_confirmed)`% [`r tbrounding(desc_residents$CT_p_confirmed_lower)`%; `r tbrounding(desc_residents$CT_p_confirmed_upper)`%], with an incidence rate of `r tbrounding(desc_residents$CT_IR_confirmed)` per 100,000 [`r tbrounding(desc_residents$CT_IR_confirmed_lower)`; `r tbrounding(desc_residents$CT_IR_confirmed_upper)`].

Kaplan-Meier estimates of the temporal trend in symptomatic and confirmed cases are shown in `r fig_nums("fig_KM_CT_plots", display = "cite")`.

In England, `r england_results$FSHC_confirmed` infections were confirmed of a total `r formatbm(england_results$FSHC_resident_days)` residents-days between `r format((england_results$date_min), "%e %B %Y")` and `r format(england_results$date_max, "%e %B %Y")`. In comparison, the survey of English community households[@cisbulletin2020] found a total of `r england_results$cis_confirmed` confirmed cases out of `r formatbm(england_results$cis_person_days)` person-days during the same period. This implies a confirmed infection rate ratio comparing care homes to the community of `r tbrounding(england_results$results$measure[2,"estimate"])` [`r tbrounding(england_results$results$measure[2,"lower"]) `; `r tbrounding(england_results$results$measure[2,"upper"])`].



`r table_nums("incidence_CT_residents")`

| Residents     |  Symptomatic  | Confirmed  |    All homes <br>  Covid-19-related deaths  | Symptomatic  |  Confirmed  | Outbreak homes <br>  Covid-19-related deaths  |
| ------------- | -------------:| -------------:|-------------:|-------------:|-------------:|-------------:|
| Cases      | `r formatbm(desc_residents$CT_total_symptomatic)` |	`r formatbm(desc_residents$CT_total_confirmed)` |	`r formatbm(desc_residents$CT_total_cdeath)` | `r formatbm(desc_residents_outbreak_only$CT_total_symptomatic)` |	`r formatbm(desc_residents_outbreak_only$CT_total_confirmed)` | 	`r formatbm(desc_residents_outbreak_only$CT_total_cdeath)` |
|	$N$ exposed  | `r formatbm(desc_residents$CT_total_residents)`|	`r formatbm(desc_residents$CT_total_residents)`|	 	`r formatbm(desc_residents$CT_total_residents)`| `r formatbm(desc_residents_outbreak_only$CT_total_residents)`|	`r formatbm(desc_residents_outbreak_only$CT_total_residents)`|	`r formatbm(desc_residents_outbreak_only$CT_total_residents)`|	
|	Total exposure (days)| `r formatbm(desc_residents$CT_total_symptomatic_denom)`	|`r formatbm(desc_residents$CT_total_confirmed_denom)`	| `r formatbm(desc_residents$CT_total_cdeath_denom)`	|  `r formatbm(desc_residents_outbreak_only$CT_total_symptomatic_denom)`	|`r formatbm(desc_residents_outbreak_only$CT_total_confirmed_denom)` |`r formatbm(desc_residents_outbreak_only$CT_total_cdeath_denom)` |
|	Incidence proportion (%)  | `r tbrounding(desc_residents$CT_p_symptomatic)` [`r tbrounding(desc_residents$CT_p_symptomatic_lower)`; `r tbrounding(desc_residents$CT_p_symptomatic_upper)`]| `r tbrounding(desc_residents$CT_p_confirmed)` [`r tbrounding(desc_residents$CT_p_confirmed_lower)`; `r tbrounding(desc_residents$CT_p_confirmed_upper)`] | `r tbrounding(desc_residents$CT_p_cdeath)` [`r tbrounding(desc_residents$CT_p_cdeath_lower)`; `r tbrounding(desc_residents$CT_p_cdeath_upper)`] | `r tbrounding(desc_residents_outbreak_only$CT_p_symptomatic)` [`r tbrounding(desc_residents_outbreak_only$CT_p_symptomatic_lower)`; `r tbrounding(desc_residents_outbreak_only$CT_p_symptomatic_upper)`]| `r tbrounding(desc_residents_outbreak_only$CT_p_confirmed)` [`r tbrounding(desc_residents_outbreak_only$CT_p_confirmed_lower)`; `r tbrounding(desc_residents_outbreak_only$CT_p_confirmed_upper)`] | `r tbrounding(desc_residents_outbreak_only$CT_p_cdeath)` [`r tbrounding(desc_residents_outbreak_only$CT_p_cdeath_lower)`; `r tbrounding(desc_residents_outbreak_only$CT_p_cdeath_upper)`] | 
|	Incidence rate (per 100,000 person-days) | `r tbrounding(desc_residents$CT_IR_symptomatic)` [`r tbrounding(desc_residents$CT_IR_symptomatic_lower)`; `r tbrounding(desc_residents$CT_IR_symptomatic_upper)`] |`r tbrounding(desc_residents$CT_IR_confirmed)` [`r tbrounding(desc_residents$CT_IR_confirmed_lower)`; `r tbrounding(desc_residents$CT_IR_confirmed_upper)`] | `r tbrounding(desc_residents$CT_IR_cdeath)` [`r tbrounding(desc_residents$CT_IR_cdeath_lower)`; `r tbrounding(desc_residents$CT_IR_cdeath_upper)`] | `r tbrounding(desc_residents_outbreak_only$CT_IR_symptomatic)` [`r tbrounding(desc_residents_outbreak_only$CT_IR_symptomatic_lower)`; `r tbrounding(desc_residents_outbreak_only$CT_IR_symptomatic_upper)`] |`r tbrounding(desc_residents_outbreak_only$CT_IR_confirmed)` [`r tbrounding(desc_residents_outbreak_only$CT_IR_confirmed_lower)`; `r tbrounding(desc_residents_outbreak_only$CT_IR_confirmed_upper)`] |`r tbrounding(desc_residents_outbreak_only$CT_IR_cdeath)` [`r tbrounding(desc_residents_outbreak_only$CT_IR_cdeath_lower)`; `r tbrounding(desc_residents_outbreak_only$CT_IR_cdeath_upper)`] |


```{r fig_KM_CT_plots, fig.height = 4, fig.width = 12, message=FALSE}

km_ct_residents_symp$y <- (1-km_ct_residents_symp$S_t) * desc_residents$CT_total_residents
km_ct_residents_confirmed$y <- (1-km_ct_residents_confirmed$S_t) * desc_residents$CT_total_residents
km_ct_residents_deaths$y <- (1-km_ct_residents_deaths$S_t) * desc_residents$CT_total_residents
                              
write.csv(km_ct_residents_symp, file = "supp_table_kaplan_meier_residents_symptomatic.csv", row.names = F)
write.csv(km_ct_residents_confirmed, file = "supp_table_kaplan_meier_residents_confirmed.csv", row.names = F)
write.csv(km_ct_residents_deaths, file = "supp_table_kaplan_meier_residents_deaths.csv", row.names = F)

all_km_residents <- bind_rows(
  km_ct_residents_symp,
  km_ct_residents_confirmed,
  km_ct_residents_deaths
)
all_km_residents$Event <- factor(
  all_km_residents$event,
  levels = c(
    "Symptomatic case",
    "Confirmed infection",
    "Covid-19-related death"
  )
)

km_residents_graph <- ggplot(aes(x = date, y = 1-S_t, 
           ymax = 1 - St_max,
           ymin = 1 - St_min,
           color = Event), data = all_km_residents) +
  geom_ribbon(alpha=0.1, linetype = 2 ) +
  geom_path(lwd=1.2) +
  geom_text(aes(label = if_else(
    date == get_monday_date(date),
    formatbm(round((1-S_t) * desc_residents$CT_total_residents)),
    ""
  )), size = 3, position = position_nudge(y = .02)) +
  scale_y_continuous("Cumulative incidence",
                     breaks = seq(0,1,.02)) +
  ggsci::scale_color_lancet() +
  scale_x_date(name = "Date", 
               breaks = unique(get_monday_date(all_km_residents$date)),
               labels = format.Date(
                 unique(get_monday_date(all_km_residents$date)),
                 "%e %b %Y"
               )) +
  theme_bw()  +
  theme(axis.text.x = element_text(angle = 25, vjust = 1, hjust=1)) +
  coord_cartesian(ylim = c(0,0.27)) + ggtitle("(A) Residents")

all_km_staff <- bind_rows(
  km_staff_symptomatic,
  km_staff_confirmed
)
all_km_staff$Event <- factor(
  all_km_staff$event,
  levels = c(
    "Symptomatic case",
    "Confirmed infection"
  )
)

km_staff_symptomatic$y <- (1-km_staff_symptomatic$S_t) * desc_staff$total_staff
km_staff_confirmed$y <- (1-km_staff_confirmed$S_t) * desc_staff$total_staff
write.csv(km_staff_symptomatic, file = "supp_table_kaplan_meier_staff_symptomatic.csv", row.names = F)
write.csv(km_staff_confirmed, file = "supp_table_kaplan_meier_staff_confirmed.csv", row.names = F)

km_staff_graph <- ggplot(aes(x = date, y = 1-S_t, 
           ymax = 1 - St_max,
           ymin = 1 - St_min,
           color = Event), data = all_km_staff) +
  geom_ribbon(alpha=0.1, linetype = 2,stat = ) +
  geom_path(lwd=1.2) +
  geom_text(aes(label = if_else(
    date == get_monday_date(date),
    formatbm(round((1-S_t) * desc_staff$total_staff)),
    ""
  )), size = 3, position = position_nudge(y = .02)) +
  ggsci::scale_color_lancet()+
  scale_y_continuous("Cumulative incidence",
                     breaks = seq(0,1,.02)) +
  scale_x_date(name = "Date", 
               breaks = unique(get_monday_date(km_staff_symptomatic$date)),
               labels = format.Date(
                 unique(get_monday_date(km_staff_symptomatic$date)),
                 "%e %b %Y"
               )) +
  theme_bw() +
  theme(legend.position = "none", 
        axis.text.x = element_text(angle = 25, vjust = 1, hjust=1)) +
  coord_cartesian(ylim = c(0,0.27)) +  ggtitle("(B) Staff")

km_ct_plots <- ggpubr::ggarrange(
  km_residents_graph,
  km_staff_graph,
  widths = c(1.4, 1)
)

pdf("figure2.pdf", 12,4)
km_ct_plots
dev.off()
km_ct_plots
```

*Note*: underlying data available from supplementary material 3.

`r fig_nums("fig_KM_CT_plots")`


`r formatbm(desc_staff$CT_symptomatic_total)`/`r formatbm(desc_staff$total_staff)` staff (`r tbrounding(desc_staff$CT_symptomatic_p)`% [`r tbrounding(desc_staff$CT_symptomatic_p_lower)`%; `r tbrounding(desc_staff$CT_symptomatic_p_upper)`%]) reported symptoms of infection during the study period, and `r formatbm(desc_staff$CT_confirmed_total)` (`r tbrounding(desc_staff$CT_confirmed_p)`% [`r tbrounding(desc_staff$CT_confirmed_p_lower)`%; `r tbrounding(desc_staff$CT_confirmed_p_upper)`%]) had a confirmed infection (`r table_nums("incidence_CT_staff", display="cite")`, `r fig_nums("fig_KM_CT_plots", display = "cite")`).


`r table_nums("incidence_CT_staff")`


|   Staff       |  Symptomatic  |    Confirmed  | 
| ------------- | -------------:| -------------:|
| Cases      | 	`r formatbm(desc_staff$CT_symptomatic_total)`|	`r formatbm(desc_staff$CT_confirmed_total)` |
|	$N$ exposed  | `r formatbm(desc_staff$total_staff)`|	`r formatbm(desc_staff$total_staff)`|
|	Total exposure (days)| `r formatbm(desc_staff$CT_symptomatic_denom)`	|`r formatbm(desc_staff$CT_confirmed_denom)`|
|	Cumulative incidence (%)  | 	`r tbrounding(desc_staff$CT_symptomatic_p)` [`r tbrounding(desc_staff$CT_symptomatic_p_lower)`; `r tbrounding(desc_staff$CT_symptomatic_p_upper)`]	| `r tbrounding(desc_staff$CT_confirmed_p)` [`r tbrounding(desc_staff$CT_confirmed_p_lower)`; `r tbrounding(desc_staff$CT_confirmed_p_upper)`] |
|	Incidence rate (per 100,000 person-days) | `r tbrounding(desc_staff$CT_symptomatic_IR)` [`r tbrounding(desc_staff$CT_symptomatic_IR_lower)`; `r tbrounding(desc_staff$CT_symptomatic_IR_upper)`]| `r tbrounding(desc_staff$CT_confirmed_IR)` [`r tbrounding(desc_staff$CT_confirmed_IR_lower)`; `r tbrounding(desc_staff$CT_confirmed_IR_upper)`] |


Estimates of incidence for private residents derived from Datix are reported in supplementary material 2.

## Mortality in residents

`r desc_residents$CT_total_cdeath` Covid-related resident deaths were reported in the aggregate dataset, equivalent to a crude incidence of `r tbrounding(desc_residents$CT_p_cdeath)`% [`r tbrounding(desc_residents$CT_p_cdeath_lower)`; `r tbrounding(desc_residents$CT_p_cdeath_upper)`] or `r  tbrounding(desc_residents$CT_IR_cdeath)` [`r  tbrounding(desc_residents$CT_IR_cdeath_lower)`; `r  tbrounding(desc_residents$CT_IR_cdeath_upper)`] per 100,000 resident-days. `r tbrounding(sum(new_cases$new_deaths_hospital, na.rm = T)/desc_residents$CT_total_cdeath*100)`% of these deaths took place in hospital (`r table_nums("incidence_CT_residents", display = "cite")`).

Individual-level data were available for `r formatbm(desc_residents$DAT_total_residents)` (`r tbrounding(desc_residents$DAT_total_residents/desc_residents$CT_total_residents*100)`%) residents.  `r tbrounding(mean(residents$home_type=="Nursing")*100)`% of residents were in a nursing home bed, and 39.2% received dementia care (`r table_nums("tab_resident_descriptives", display = "cite")`). `r formatbm(desc_residents$DAT_total_deaths)` all-cause deaths occurred in these residents, equivalent to a crude cumulative incidence of `r tbrounding(desc_residents$DAT_p_death)`% [`r tbrounding(desc_residents$DAT_p_death_lower)`%; `r tbrounding(desc_residents$DAT_p_death_upper)`%]. The proportion of resident deaths was two-fold higher in care homes with outbreaks compared to those without outbreaks (22.6% versus 11.2%). 


`r desc_residents$DAT_CFR$y` deaths occurred in residents with confirmed infection, equivalent to an all-cause case-fatality rate in infected residents (Groups C and D) of `r tbrounding(desc_residents$DAT_CFR_rate)`% [`r tbrounding(desc_residents$DAT_CFR_rate_lower)`%; `r tbrounding(desc_residents$DAT_CFR_rate_upper)`%] (`r table_nums("tab_CFR_age_sex", display = "cite")`). The case-fatality rate increased with age and was higher in men compared to women.

`r table_nums("tab_resident_descriptives")`

```{r table_resident_descriptives, message = FALSE, results="asis"}

residents_overview <- residents_overview %>% 
  mutate(outbreak = as.integer(home_code %in% desc_residents_outbreak_only$outbreak_homes) ) %>% 
  dplyr::mutate(
    covid_status_outbreak = as.factor(case_when(
    covid_status == "Uninfected" & outbreak == 0 ~ "0 Uninfected (other home)",
    covid_status == "Symptomatic (not confirmed)" &
      outbreak==0 ~ "1 Symptomatic not confirmed  (other home)",
    covid_status == "Uninfected" & outbreak == 1 ~ "2 Uninfected (outbreak home)",
    covid_status == "Symptomatic (not confirmed)" &
      outbreak==1 ~ "3 Symptomatic not confirmed  (outbreak home)",
    covid_status == "Asymptomatic confirmed" ~ "4 Confirmed asymptomatic",
    covid_status == "Symptomatic confirmed" ~ "5 Confirmed symptomatic"
  ))) %>% 
  mutate(outbreak = relevel(as.factor(dplyr::case_when(
    home_code %in% desc_residents_outbreak_only$outbreak_homes ~ "Outbreak homes",
    TRUE ~ "Other homes"
    )), "Outbreak homes"))
 
arsenal::tableby(
  outbreak  ~ Sex + Age  +  `Resident type` + `Admission type`  + `Funding type` +  
    `Infection status by 14 June` + `Status as of 14 June` + `Region/nation` + `Index of Multiple Deprivation`, 
  control = arsenal::tableby.control(test = FALSE, numeric.stats = c("Nmiss", "meansd"), digits = 1L),
  data = mutate(residents_overview,
                Sex = gender,
                Age = ageg,
                `Resident type` = user_type2,
                `Admission type` = admission_type2,
                `Funding type` = home_type,
                `Infection status by 14 June` = covid_status, 
                `Status as of 14 June` = status,
                `Region/nation` = region_UK,
                `Index of Multiple Deprivation` = uk_imd_england_quintile
  )) %>% summary()
```

 
```{r factors_outbreak}
# home_total_confirmed$outbreak <-  as.factor(home_total_confirmed$CT_confirmed>0)
# # factors_outbreak <- glm( 
# #   outbreak ~ staff_to_bed_ratio + bed_tot_category + 
# #     pct_occupancy +occ_bedroom_ratio + region_UK , 
# #   family = binomial(), data = home_total_confirmed)
# # summary(factors_outbreak)
# explanatory = c( "bed_tot_category", "pct_occupancy", "staff_to_bed_ratio",
#                  "occ_bedroom_ratio",
#                  #"younger_person", "residential_general", "factor(residential_dementia)",
#                  # "nursing_general","nursing_dementia", 
#                  "region_UK")
# dependent = "outbreak"
# odds_outbreak <-  finalfit(home_total_confirmed,
#                            dependent, 
#                            explanatory, column = T,
#                            add_dependent_label = F)  
# knitr::kable(odds_outbreak,
#              row.names=FALSE, align=c("l", "l", "r", "r", "r", "r"))
#  
# ggplot(home_total_confirmed, aes(occ_bedroom_ratio, pct_occupancy, colour = outbreak)) +
#   geom_point() +
#   ggsci::scale_color_lancet() +
#   xlab("Ratio mean occupancy:number bedroom") + ylab("Ratio mean occupancy:beds")
```

`r table_nums("tab_CFR_age_sex")`


```{r tab_CFR_age_sex, results="asis"}
CFR_age_sex <- residents_overview %>%
  mutate(Age = ageg, Sex = gender) %>% 
  group_by(Sex, Age) %>% 
  summarise(
    n = n_distinct(resident_id),
    resident_days = sum(resident_days),
    confirmed_infections = sum(confirmed == 1),
    deaths = sum(status == "Deceased"),
    deaths_confirmed = sum(status == "Deceased" & confirmed == 1)) %>% 
  ungroup()

CFR_age_sex <- bind_rows(
  CFR_age_sex,
  colSums(CFR_age_sex[3:7])
) %>% mutate(
  Sex = tidyr::replace_na(Sex, "All"),
  Age = tidyr::replace_na(Age, "")
)

CFR_age_sex <- CFR_age_sex %>% 
  mutate(
    cfr = tbrounding(deaths_confirmed/confirmed_infections*100),
    cfr_lower = tbrounding(epitools::binom.exact(deaths_confirmed, confirmed_infections)$lower*100),
    cfr_upper = tbrounding(epitools::binom.exact(deaths_confirmed, confirmed_infections)$upper*100),
    RR = relative_risk(deaths_confirmed, confirmed_infections - deaths_confirmed,
                       deaths - deaths_confirmed, n - confirmed_infections -(deaths - deaths_confirmed)),
    RR_SE = relative_risk_SE(deaths_confirmed, confirmed_infections - deaths_confirmed,
                       deaths - deaths_confirmed, n - confirmed_infections -(deaths - deaths_confirmed))
  ) %>%  ungroup() %>% 
  transmute(
    Age,
    Sex,
    N = formatbm(n),
    `Confirmed infections` = confirmed_infections,
    `Total deaths` = formatbm(deaths),
    `Deaths in confirmed infections` = deaths_confirmed,
    `Case-fatality rate (%)` = paste0(cfr, " [", cfr_lower, "; ", cfr_upper, "]")
    # `Relative risk` = paste0(
    #   tbrounding(RR, 2), " [",
    #   tbrounding(exp(log(RR) - 1.96 * RR_SE), 2), "; ",
    #   tbrounding(exp(log(RR) + 1.96 * RR_SE), 2), "]"
    # )
  ) 
CFR_age_sex %>%
  kable(align=c("l", "l", "r", "r", "r", "r", "r", "r"))
```


## Factors associated with confirmed infections in residents

Using individual-level resident data, factors affecting the rate of confirmed cases were investigated in a Cox Proportional Hazard model. Male sex, age $\geq$ 85 years, and residence in a nursing home (adjusted HR = 1.5 [1.2; 1.8]) were all independently associated with increased risk of confirmed Covid-19 infection (`r table_nums("tab_CoxPH_confirmed", display = "cite")`). Large care homes had greater rates of infection (adjusted HR = 1.8 [1.4; 2.4] for care homes with $\geq$ 70 beds versus <35 beds). Care home baseline occupancy and staffing ratios had the greatest effect on residents risk of infection. For example, the adjusted hazard ratio for confirmed infection was 2.5 times [1.9; 3.3] greater in homes with 0.85-1 resident per room versus homes with 0.7-0.85 resident per room. In homes with more residents than bedrooms, hazards were 10 times [6.9; 15] greater.

Higher staff to resident ratios were associated with lower risk of infection: an increase by 10 percentage points of the bed to staff ratio was associated with a 23% increase in infection (adjusted HR = 1.23 [1.17; 1.31]).


`r table_nums("tab_CoxPH_confirmed")`

```{r hazard_ratios_confirmed,   results="asis"}
# cph_conf <- coxph(Surv(time = start_int, time2 = stop_int +1, event = confirmed) ~ gender + ageg+
#                     home_type+user_type2+  bed_tot_category + bed_to_staff_ratio +occ_bedroom_ratio_g6, data = residents_overview)
#  summary(cph_conf)
# cox.zph(cph_conf)
# survfit(Surv(time = start_int, time2 = stop_int +1, event = confirmed)~factor(gender), data = residents_overview) %>% ggsurvplot(ylim=c(.85,1), conf.int = T, legend = "right")
residents_overview$uk_imd_england_quintile <- factor(residents_overview$uk_imd_england_quintile,
                                                     levels = c(
                                                       '3', 
                                                       '1 - least deprived', '2', '4', '5 - most deprived'
                                                     ))
residents_overview$bed_to_staff_ratio <- 1/residents_overview$staff_to_bed_ratio
explanatory = c("gender", "ageg", "home_type", "user_type2",  "uk_imd_england_quintile",
                "bed_tot_category", "bed_to_staff_ratio",  "occ_bedroom_ratio_g6")
dependent = "Surv(time = start_int, time2 = stop_int +1, event = confirmed)"
CPH_confirmed <-  finalfit(residents_overview,
                           dependent, 
                           explanatory, column = T,
                           add_dependent_label = F)  %>%     ff_remove_p() 
knitr::kable(CPH_confirmed,
             row.names=FALSE, align=c("l", "l", "r", "r", "r", "r"))
```




```{r tablefiller1, results="asis"}
# arsenal::tableby(
#   confirmed  ~ gender + ageg  +  home_type + user_type2 +bed_tot_category + bed_to_staff_ratio +  occ_bedroom_ratio_g6, 
#   control = arsenal::tableby.control(test = FALSE, cat.stats = "countrowpct", digits = 1L),
#   data = residents_overview) %>%  summary()

# residents_overview %>% 
#   mutate(confirmed = as.factor(confirmed)) %>% 
#   summary_factorlist("confirmed", explanatory) %>% kable
```



## Factors associated with all-cause mortality

The time-dependent Cox proportional hazard models in `r table_nums("tab_CoxPH_death", display = "cite")` examine the relationship between infection status (groups A-D) and mortality. After controlling for other risk factors, increased mortality was associated with older age, male gender (adjusted HR = 1.4 [1.3; 1.6]), and receiving nursing care (adjusted HR = 1.4 [1.2; 1.5]).

We estimated excess mortality in outbreak and non-outbreak homes, taking individuals with no evidence of infection (group A) in non-outbreak homes as the reference group. Risk of all-cause mortality was almost two-fold higher in residents in Group A (no direct evidence of infection) in outbreak versus non-outbreak homes (adjusted HR = 2.0 [1.7; 2.2]). Risk of death was also higher in group B (residents with symptoms but unconfirmed infection) in outbreak versus non-outbreak homes relative to the baseline group (adjusted HR = 4.3 [3.0; 6.2] versus 9.4 [7.6; 12]).  All-cause mortality was strongly associated with group C - asymptomatic confirmed infection (adjusted HR = 3.3 [2.0; 5.7]) and group D - symptomatic confirmed infection (adjusted HR = 13 [11; 16]), compared to baseline.

It is important to note these hazard ratio estimates do not give a comprehensive measure of effect: hazards were not proportional across these categories (`r fig_nums("fig_KM_mortality", display="cite")`). 

```{r residents_daily}
residents_daily <- tline %>% 
  filter(rday==1)  %>% 
  left_join(home_first_case) %>%
  mutate(outbreak = dplyr::case_when(
    date >= first_case_date ~ 1L,
    date < first_case_date ~ 0L,
    TRUE ~ 0L
  )) %>% 
  group_by(resident_id) %>% 
  mutate(
    death = case_when(
    status == "Deceased" & date == max(date) ~ 1L,
    TRUE ~ 0L
  ),death_Apr = case_when(
    status == "Deceased" & date == max(date) & date >= as.Date("2020-04-01") ~ 1L,
    TRUE ~ 0L
  )) %>% 
  ungroup() %>% 
  mutate(symptomatic = -susceptible_symptomatic+1,
         confirmed = -susceptible_confirmed+1,
         symptomatic_confirmed = (-susceptible_symptomatic+1)*(-susceptible_confirmed+1)) %>% 
  mutate(covid_status_outbreak = as.factor(case_when(
    symptomatic==0 & confirmed == 0 & outbreak == 0 ~ "0 Uninfected (other home)",
    symptomatic==1 & confirmed == 0 & outbreak == 0 ~ "1 Symptomatic not confirmed  (other home)",
    symptomatic==0 & confirmed == 0 & outbreak == 1 ~ "2 Uninfected (outbreak home)",
    symptomatic==1 & confirmed == 0 & outbreak == 1 ~ "3 Symptomatic not confirmed  (outbreak home)",
    symptomatic==0 & confirmed == 1 ~ "4 Confirmed asymptomatic",
    symptomatic==1 & confirmed == 1 ~ "5 Confirmed symptomatic"
  )))
residents_daily$covid_status_outbreak_digit <- as.factor(
  as.numeric(residents_daily$covid_status_outbreak)-1)
residents_daily <- bind_cols(
  residents_daily,
  as_tibble(model.matrix(~covid_status_outbreak_digit, residents_daily)[,-1])
)

```


`r table_nums("tab_CoxPH_death")`

```{r hazard_ratios_death, results="asis"}
# cph_death2 <- coxph(Surv(date1, date2, death_status) ~ gender+ ageg + home_type + user_type2 +
#                       bed_tot_category + bed_to_staff_ratio + occ_bedroom_ratio_g6 +
#                       covid_status_outbreak  + cluster(resident_id), data = residents_episodes)
# summary(cph_death2)
# cox.zph(cph_death2)
residents_episodes$uk_imd_england_quintile <- factor(residents_episodes$uk_imd_england_quintile,
                                                     levels = c(
                                                       '3', 
                                                       '1 - least deprived', '2', '4', '5 - most deprived'
                                                     ))

residents_episodes$bed_to_staff_ratio <- 1/residents_episodes$staff_to_bed_ratio
explanatory = c("gender", "ageg", "home_type", "user_type2", "uk_imd_england_quintile",
                "bed_tot_category", "bed_to_staff_ratio", "occ_bedroom_ratio_g6",
                "covid_status_outbreak",  "cluster(resident_id)")
dependent = "Surv(time = date1, time2 = date2, event = death_status)"
CPH_death <-  finalfit(residents_episodes, dependent, explanatory, 
                       column = T, add_dependent_label = F)  %>%   ff_remove_p() 
knitr::kable(CPH_death, row.names=FALSE, align=c("l", "l", "r", "r", "r", "r"))
```

*Note:* Baseline group = uninfected residents in non-outbreak care home


```{r tablefiller2, results="asis"}
# residents_overview$death_status <- as.integer(residents_overview$status == "Deceased")
# arsenal::tableby(
#   death_status  ~ gender + ageg  +  home_type + user_type2  + bed_to_staff_ratio + bed_tot_category +  occ_bedroom_ratio_g6 + covid_status_outbreak, 
#   control = arsenal::tableby.control(test = FALSE, cat.stats = "countrowpct", digits = 1L),
#   data = residents_overview) %>%  summary()

# residents_overview %>% 
#   mutate(confirmed = as.factor(confirmed)) %>% 
#   summary_factorlist("confirmed", explanatory) %>% kable
```



```{r fig_KM_mortality,  fig.height = 6, fig.width = 8, message=F}
KM_mortality_by_covid_status <- survfit(
  Surv(time = start_int, time2 = stop_int, event = death_status) ~ covid_status + outbreak, 
  data = mutate(
    residents_overview, 
    death_status = as.integer(status == "Deceased")
  ))
KM_mortality_plot <- ggsurvplot_facet(
  KM_mortality_by_covid_status,
  mutate(residents_overview, 
         death_status = as.integer(status == "Deceased")  ),
  facet.by  = "covid_status",
  legend.labs = c("Non-outbreak home", "Outbreak home"),
  short.panel.labs	 = T, break.x.by	= 7, 
  break.y.by = .1,
  palette = "aaas", conf.int = T,
  scales = "free", ggtheme = theme_bw(), xlim = c(0, 104), 
  xlab  = paste0("Days since ", format(date_min, "%e %b %Y")),
  conf.int.alpha = .15, censor.shape = 124, censor.size = 2, size = 0.5)

KM_mortality_plot <- KM_mortality_plot +  
  scale_x_continuous(name = "Date", 
                     breaks = c(seq(0, 7*50, 7)),
                     labels = format.Date(date_min + seq(0, 7*50, 7), "%e %b %Y" )) +
  theme(axis.text.x = element_text(size = 8, angle = 35, vjust = 1, hjust=1)) 
pdf("figure3.pdf", 8, 6)
KM_mortality_plot
dev.off()
KM_mortality_plot

summary(KM_mortality_by_covid_status)[c("time",  "n.risk", "n.event", "n.censor", "surv", "strata")] %>% 
  as_tibble %>% 
  mutate(infection = gsub("covid_status=", "", gsub(", outbreak=.*", "", strata)),
         outbreak = gsub(".*, outbreak=", "", strata))  %>% 
  select(-strata) %>% 
  write.csv(file = "supp_table_kaplan_meier_indiv_alldeaths.csv", row.names = F)
```

`r fig_nums("fig_KM_mortality")`

## Attributable mortality

Model-based estimates of attributable mortality were derived from the individual-level data. Overall, 567/1,694 (33%) deaths were attributed to Covid-19. In homes with outbreaks only 28% (159 residents) of the mortality attributable to COVID-19 occurred in people with confirmed infection (Groups C and D), (`r table_nums("tab_attributable_deaths", display = "cite")`). Exclusion of the early pandemic period in sensitivity analysis increased attributable mortality to 560/1,343 (41.7%). Model-based estimates of deaths based on individual-level were slightly higher (8%) than counts from the aggregate data.

 
`r table_nums("tab_attributable_deaths")`

```{r attributable_deaths, warning=F, message=F, results = "asis"}
cph_death3 <- coxph(Surv(date1, date2, death_status) ~
                    gender+ ageg + home_type + covid_status_outbreak_digit +
                    staff_to_bed_ratio + bed_tot_category + occ_bedroom_ratio_g6 +
                    cluster(resident_id), data =  residents_episodes)

HRs_covid <- tibble::enframe(cph_death3$coefficients[grep("covid_status_outbreak", 
                                                          names(cph_death3$coefficients))]) %>% 
  transmute(covid_status_outbreak_digit = gsub("covid_status_outbreak_digit", "", name),
            HR = exp(value))
HRs_CI_covid <- as_tibble(exp(confint(cph_death3))[grep("covid_status_outbreak", 
                                                          names(cph_death3$coefficients)),]) %>% 
  rename(HR_lower =  `2.5 %`,
         HR_upper = `97.5 %`)
HRs_CI_covid$covid_status_outbreak_digit <- gsub(
  "covid_status_outbreak_digit", "",
  grep("covid_status_outbreak", names(cph_death3$coefficients), value = T)
) 
HRs_covid <- merge(HRs_covid, HRs_CI_covid)

attributable_deaths <- residents_episodes %>%
  group_by(covid_status_outbreak_digit, covid_status_outbreak) %>%
  summarise(
    rdays = sum(as.integer(date2-date1)),
    deaths = sum(death_status == 1),
    deaths_apr = sum(death_status == 1 & date2 >= 30)
    ) %>% 
  left_join(HRs_covid) %>% 
  mutate(HR = tidyr::replace_na(HR, 1),
           HR_lower = tidyr::replace_na(HR_lower, 1),
           HR_upper = tidyr::replace_na(HR_upper, 1))



# All deaths

death_predictions <- 1-predict(cph_death3, residents_episodes, type = "survival")
att_fractions <- 0
for(i in 1:5) {
  residents_episodes_counterfact <- mutate(
    residents_episodes, 
    covid_status_outbreak_digit = case_when(
      covid_status_outbreak_digit == as.character(i) ~ factor("0", levels = 0:5),
      TRUE ~ covid_status_outbreak_digit)
  )
  death_predictions_counterfactual <- 1 - predict(cph_death3, 
                                                  residents_episodes_counterfact, 
                                                  type = "survival")
  att_fractions[i+1] <- sum(death_predictions - death_predictions_counterfactual) / sum(death_predictions)
}

rm(death_predictions, death_predictions_counterfactual)

attributable_deaths$AF <- att_fractions


# Just for April-June
death_predictions <- 1-predict(cph_death3, residents_episodes_short, type = "survival")
att_fractions <- 0
for(i in 1:5) {
  residents_episodes_counterfact <- mutate(
    residents_episodes_short, 
    covid_status_outbreak_digit = case_when(
      covid_status_outbreak_digit == as.character(i) ~ factor("0", levels = 0:5),
      TRUE ~ covid_status_outbreak_digit)
  )
  death_predictions_counterfactual <- 1 - predict(cph_death3, 
                                                  residents_episodes_counterfact, 
                                                  type = "survival")
  att_fractions[i+1] <- sum(death_predictions - death_predictions_counterfactual) / sum(death_predictions)
}
rm(death_predictions, death_predictions_counterfactual)

attributable_deaths$AF_apr <- att_fractions

attributable_deaths <- bind_rows(attributable_deaths, 
                                 colSums(attributable_deaths[,c("rdays", "deaths", "deaths_apr",
                                                                "AF", "AF_apr")]))
attributable_deaths %>% ungroup() %>% transmute(
  `Infection/outbreak status` = tidyr::replace_na(as.character(covid_status_outbreak), "TOTAL"),
  `Adjusted HR` = paste0(tbrounding(HR,2), " [",
                        tbrounding(HR_lower,2),"; ",
                        tbrounding(HR_upper,2), "]"),
  `Resident-days` = formatbm(rdays),
  `Total deaths` = formatbm(deaths),
  # `Total deaths (April-June)` = formatbm(deaths_apr),
  `Deaths attributable to Covid-19 (% all-cause deaths)` = paste0(
    round(AF * sum(deaths/2)), " (",
    tbrounding(AF*100, 2), ")"),
  # `Deaths attributable to Covid-19 (% all-cause deaths April-June)` = paste0(
  #   round(AF_apr * sum(deaths_apr/2)), " (",
  #   tbrounding(AF_apr*100, 2), ")")
) %>% kable(align=c("l", rep("r", 4)))

```


# Interpretation

## Main findings 



This population-level study demonstrates the major impact of Covid-19 on care homes, with 22% of residents and 16% of staff experiencing symptoms and overall case-fatality of 35.7%. Residents with no direct evidence of infection in care homes with outbreaks had twice the mortality of the equivalent group in care homes without outbreaks, implying substantial case under-ascertainment. Less than one-third of deaths attributable to COVID-19 in outbreak homes were confirmed which is likely due to poor availability of testing until late in the pandemic. In addition to the need for active surveillance linked to increased testing capacity, higher staff to resident ratios and reduced care home occupancy are critically important to reducing the spread of infection.  

Our estimates of the prevalence of confirmed Covid-19 infections and deaths in residents are comparable to a large survey of care home managers in England.[@onsVivaldi2020] However, both studies are likely to have underestimated the proportion of residents who became infected due to limited testing, asymptomatic infection[@Salcher-Konrad2020] and moderate sensitivity of PCR testing.[@Kucirka2020] Our estimate of `r tbrounding(desc_residents$DAT_CFR_rate)`% case-fatality in residents with confirmed infection over a mean of 71 days is higher than previous literature,[@Salcher-Konrad2020] but is based on longer follow-up, a larger number of residents, and our study population had higher overall mortality. For example, an outbreak investigation[@Easter6] in 4 care homes in London, UK measured a case-fatality rate of 17% among 126 residents over a period of 62 days, while Stall et al.[@Stall2020] measured a rate of 28% in over a period of 53 days in a Canadian study.

Whereas two-thirds of care homes in our study reported at least one case of infection or death, just 44% of care homes have notified an outbreak to PHE.[@PHE12020]  This suggests that nationally, local health protection teams may be unaware of Covid-19 infections in up to 1 in 5 care homes. Integration of data systems, so that test results can be accessed and acted upon by local public health teams is fundamental to the pandemic response.

In common with a Canadian cohort study,[@Brown2020] we found strong associations between infections and care home occupancy. We also identified lower staff to resident ratios as a risk factor for infection. These organisational factors, linked to chronic underfunding of the care home sector, are likely to facilitate the implementation of infection control procedures[@dhICguideline2020] such as isolating or cohorting infected residents, staff training, and regular environmental deep cleaning. When staff care for fewer residents they also have reduced likelihood of spreading infection between patients. Higher staff to resident ratios may also decrease reliance on agency staff who may spread infection between homes, and indicate better resourced care homes with greater access to protective personal equipment.


## Strengths and limitations

The unique surveillance system we established in partnership with FSHCG allowed us to track infections throughout the entire pandemic period across a large number of care homes, and identify symptomatic as well as confirmed and asymptomatic cases. To our knowledge, this is the most compete reporting system for Covid-19 infections in care homes published to date.  It is possible that care homes that paid less attention to active surveillance to support control will have had higher levels of uncontrolled outbreaks compared to those seen in this study.

A limitation is lack of access to information on comorbidity and ethnicity, both of which have been shown to be important risk factors for adverse outcomes in Covid-19.[@Zhou2020] However, we were able to identify individuals with dementia, and adjust for receipt of nursing care which will partially capture comorbidity.  We also lacked information on the overall rate of care home testing.

## Clinical, research and policy implications

In the UK the number of infected residents and staff has been underestimated, due to limited availability of testing until late in the pandemic. High levels of asymptomatic infection will also lead to under-ascertainment. It is important to note however, that mortality rates were also increased in those recorded as asymptomatic infections suggesting that in an elderly cohort patients may have atypical presentations that do not conform to standard case definitions. Although our findings support increased use of testing to improve case ascertainment, frequent testing in care home residents may not always be desirable if the risk of infection is low, because  the testing procedure (nasopharyngeal swabs) is invasive and may distress vulnerable residents. Since the incubation period and serial interval of COVID-19 is short,[@KaiWang2020] the interval between successive screens required to interrupt transmission may also need to be short. Rapid early diagnosis of symptomatic cases in residents and staff and expansion of more widespread testing after a case is identified may also be effective strategies to prevent transmission. Such approaches depend on strengthened surveillance in care homes and would be greatly facilitated by the availability of near patient testing platforms, which may be achievable in larger homes.

Our findings of excess deaths in those with no direct evidence of infection may be due to under-ascertainment, direct effects of Covid-19 control measures on delivery of care, and/or indirect effects due to additional disruption caused by the outbreak.  Studies from other healthcare settings[@Lai2020; @Weinberger2020] have highlighted the ways in which Covid-19 has impacted delivery of care associated with excess mortality in individuals who are uninfected . Detailed analysis of cause of death and reasons for hospital admission in care home residents will be important to understand how the pandemic has affected the quality of care in care homes. Our analysis provides a method that could be widely applied to estimate excess mortality, provided care homes with outbreaks can be reliably identified.

Covid-19 cases are declining in Europe, but there is an opportunity to mitigate the impact of future waves of infection on care home staff and residents. Our findings suggest that countries can achieve this by adopting a holistic approach, which integrates surveillance and focused testing for Covid-19 with increased investment to reduce care home occupancy and increase staffing.

<!-- Evidence from the USA suggests that frequent testing in care homes can reduce the spread of infection,[@Dora2020] since various studies have shown effective transmission of SARS-CoV-2 from people who are infected but not yet symptomatic.[@He2020; @Kimball2020] The UK government has recently announced plans[@dhscRegularTesting2020] to increase the frequency of testing in care home staff and residents. Although our findings strongly support increased use of testing to improve case ascertainment, frequent testing in care home residents may not always be desirable if the risk of infection is low, since the testing procedure (nasopharyngeal swabs) is invasive, and it may cause distress to vulnerable residents, particularly those with dementia. Focussing testing on staff and/or developing strategies to identify care homes that are at greatest risk of outbreaks infection could support efforts to target surveillance and infection prevention activities. Alternatively the development of saliva antigen tests could provide a less invasive solution to testing. -->




# Declarations

## Funding 

This work was supported by the Economic and Social Research Council [ES/V003887/1].  This work was also supported by a National Institute for Health Research (NIHR) Clinician Scientist award (CS-2016-007 to L.S.); In-Practice fellowship (NIHR300293 to A.J.); a NIHR School of Primary Care Research fellowship (SPCR-118 to A.J.); and a NIHR In-Practice Fellowship (to M.R.). AH and HH are NIHR Senior Investigators . AH and HH are supported by Health Data Research UK (grant No. LOND1), which is funded by the UK Medical Research Council, Engineering and Physical Sciences Research Council, Economic and Social Research Council, Department of Health and Social Care (England), Chief Scientist Office of the Scottish Government Health and Social Care Directorates, Health and Social Care Research and Development Division (Welsh Government), Public Health Agency (Northern Ireland), British Heart Foundation, Wellcome Trust. HH is funded by the NIHR University College London Hospitals Biomedical Research Centre, The BigData@Heart Consortium, funded by the Innovative Medicines Initiative-2 Joint Undertaking under grant agreement No. 116074.

## Research ethics

This study was approved by the University College London Research Ethics Committee (project reference 13355/002).

## Availability of data and materials

Figure 2 and 3 data are available on request to authors. This work uses data provided by residents and collected by the Four Seasons Health Care Group as part of their care and support. These are available from the Four Seasons Health Care Group but restrictions apply to the availability of these data, which were used under license for the current study, and so are not publicly available. Data are however available from the authors upon reasonable request and with permission of the Four Seasons Health Care Group.


# Supplementary material

## Supplementary material 1: Quality and methodology report

## Supplementary material 2: Incidence of confirmed and symptomatic cases among private residents according to Datix incident reports

Datix incidents reports recorded that `r formatbm(desc_residents$unique_residents_tested)` private residents were tested at least once. Test results were known for `r formatbm(desc_residents$unique_residents_test_result)` of them (`r tbrounding(desc_residents$unique_residents_test_result/desc_residents$unique_residents_tested*100)`%), including `r formatbm(desc_residents$unique_residents_test_result_positive)` residents with a positive test result. This data should be treated as representative, as tests coming back negative were not commonly recorded on Datix. Incidence proportions and rates reported in `r  table_nums("supp_epi_DAT", display = "cite")` are lower than corresponding estimates based on outbreak counts. This is thought to be caused by a combination of underascertainment as well as linkage error.

`r table_nums("supp_epi_DAT")`

| Residents     |  Symptomatic  |  Confirmed  | All-cause death | 
| ------------- | -------------:| -------------:|-------------:|
| Cases      | `r formatbm(desc_residents$DAT_total_symptomatic)` |	`r formatbm(desc_residents$unique_residents_test_result_positive)` | `r formatbm(desc_residents$DAT_total_deaths)`  |
|	$N$ exposed  | `r formatbm(desc_residents$DAT_total_residents)`|	`r formatbm(desc_residents$DAT_total_residents)` | `r formatbm(desc_residents$DAT_total_residents)` |
|	Total exposure (days)|`r formatbm(desc_residents$DAT_total_symptomatic_denom)`|	`r formatbm(desc_residents$DAT_total_confirmed_denom)` | `r formatbm(desc_residents$total_denom)` |
|	Cumulative incidence (%)  | `r tbrounding(desc_residents$DAT_p_symptomatic)` [`r tbrounding(desc_residents$DAT_p_symptomatic_lower)`; `r tbrounding(desc_residents$DAT_p_symptomatic_upper)`] |`r tbrounding(desc_residents$DAT_p_confirmed)` [`r tbrounding(desc_residents$DAT_p_confirmed_lower)`; `r tbrounding(desc_residents$DAT_p_confirmed_upper)`] |`r tbrounding(desc_residents$DAT_p_death)` [`r tbrounding(desc_residents$DAT_p_death_lower)`; `r tbrounding(desc_residents$DAT_p_death_upper)`] |
|	Incidence rate (per 100,000) | `r tbrounding(desc_residents$DAT_IR_symptomatic)` [`r tbrounding(desc_residents$DAT_IR_symptomatic_lower)`; `r tbrounding(desc_residents$DAT_IR_symptomatic_upper)`] | `r tbrounding(desc_residents$DAT_IR_confirmed)`  [`r tbrounding(desc_residents$DAT_IR_confirmed_lower)`; `r tbrounding(desc_residents$DAT_IR_confirmed_upper)`] | `r tbrounding(desc_residents$DAT_IR_death)` [`r tbrounding(desc_residents$DAT_IR_death_lower)`; `r tbrounding(desc_residents$DAT_IR_death_upper)` ]|
  

## Supplementary material 3: Kaplan-Meier estimators data
  
  

```{r table_national_descriptives, fig.cap = tab_national_descriptives, message=F}
#
mutate_all(desc_homes,  .funs = formatbm) %>% arrange(gsub("FSHC ", "", Scope)) %>% t %>% kable
``` 

## Supplementary analysis

```{r effect_organisational_variables}
# adhoc1 <- residents_ct %>% 
#   filter(home_code %in% home_inclusion) %>% 
#   group_by(home_code) %>% 
#   summarise(confirmed_cases = sum(new_confirmed),
#             symptomatic_cases = sum(new_symptomatic),
#             denominator = sum(occupancy - I_confirmed)) %>% 
#   left_join(reference_homes) %>% 
#   left_join(select(filter(beds, year=="2020"), -year)) %>% 
#   mutate(staff_to_bed_ratio = staff_total/beds,
#          carer_to_bed_ratio = (staff_care_assistants + staff_nurses)/beds,
#          bed_tot_category = cut(beds, 
#            breaks = seq(20,100,25), right = F, 
#            paste0(seq(20, 80, 25), "–", seq(34, 94, 25), " beds"))
#          ) %>% 
#   mutate(staff_to_bed_ratio_g5 = cut(
#     staff_to_bed_ratio, c(min(staff_to_bed_ratio)-.001,
#     quantile(staff_to_bed_ratio, seq(.2, .8, .2)),
#     max(staff_to_bed_ratio)))) %>% 
#   left_join(home_mean_occupancy) %>% 
#   mutate(pct_occupancy = mean_occupancy/beds,
#          occ_bedroom_ratio = mean_occupancy/no_bedrooms) %>% 
#   mutate(occ_bedroom_ratio_g5 = cut(occ_bedroom_ratio, seq(0.2, 1.2, .2)),
#          occ_bedroom_ratio_g6 = cut(occ_bedroom_ratio, seq(0.25, 1.2, .15)))
# 
# ggplot(adhoc1, aes(staff_to_bed_ratio, confirmed_cases/denominator*100000)) +
#   geom_point() +
#   geom_smooth() +
#   ylab("Cumulative incidence per 100,000") +
#   xlab("Ratio staff : beds")
# 
# mod_staffing <- glm(confirmed_cases ~  
#   staff_to_bed_ratio + offset(log(denominator)), 
#   family = poisson(link = "log"), data = adhoc1)
# 
# 
# ggplot(adhoc1, aes(occ_bedroom_ratio, confirmed_cases/denominator*100000)) +
#   geom_point() +
#   geom_smooth() +
#   ylab("Cumulative incidence per 100,000") +
#   xlab("Ratio occupants : bedrooms (Jan-Mar 2020)")
# 
# adhoc1 %>% 
#   group_by(occ_bedroom_ratio_g5) %>% 
#   summarise(confirmed_cases = sum(confirmed_cases),
#             denominator = sum(denominator))  %>% 
#   mutate(rate = confirmed_cases/denominator*100000)

```

# References
