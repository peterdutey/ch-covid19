---
title: "Data quality report"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{validation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  echo=FALSE,
  fig.width = 7,
  fig.height = 5,
  collapse = TRUE,
  comment = "#>"
)

library(summarytools)
st_options(
  headings = FALSE,
  footnote = NA
)
source("../.Rprofile")
devtools::load_all("..")
library(ggplot2)
load_data()
```


This report is based on `r formatbm(nrow(incidents))` Datix reports of incidents dated up to `r format(max(incidents$incident_date), "%A %e %b %Y")`. Incidents relate to `r formatbm(dplyr::n_distinct(incidents$resident_id))` unique residents. 

Incidents report were obtained from `r formatbm(dplyr::n_distinct(incidents$home_code))` care homes totalling `r formatbm(sum(beds[beds$year=="2020" & beds$home_code %in% unique(incidents$home_code), "beds"]))` beds. In 2020, Four Seasons Health Care comprises `r formatbm(dplyr::n_distinct(beds[beds$year=="2020", "home_code"]))` care homes with a total of `r formatbm(sum(beds[beds$year=="2020", "beds"]))` beds.


## Classification of cases

The incident classification is not wholly consistent, as illustrated in the tabulation below. Due to this, a reclassification algorithm is used.

```{r }
print(ctable(incidents$infection_confirmed, incidents$infection_covid_19_type, useNA = "always"), method = 'render')
```

### Algorithm

The following algorithm is used to classify symptomatic, suspected, and test-confirmed cases from the Datix reports of COVID-19 infections.


```{r echo=FALSE}
DiagrammeR::grViz("../man/figure/case_classification_1.gv", width=700, height= 500)
```

```{r echo = FALSE}
DiagrammeR::grViz("../man/figure/case_classification_2.gv", width=700, height= 400)
```

### Validation

Data are tabulated below to evaluate the internal consistency of the rules set out in the previous section.

The `infection_result` field provides information on test results which broadly agrees yet sometimes conflicts with the `infection_confirmed` classification of incidents. It is potentially more up to date although it is very sparsely populated.


```{r}
print(ctable(incidents$infection_covid_19_type, incidents$covid_confirmed, useNA = "always"), method = 'render')
```

```{r}
print(ctable(incidents$infection_covid_19_type, incidents$covid_test_result, useNA = "always"), method = 'render')
```

```{r}
print(ctable(incidents$infection_confirmed, incidents$covid_test_result, useNA = "always"), method = 'render')
```

## Data quality

### Demographic information

Resident pseudoidentifiers were absent in `r sum(grepl("^MISSING", incidents$resident_id))` (`r tbrounding(mean(grepl("^MISSING", incidents$resident_id))*100)`%) of Datix incident reports. The pseudoidentifiers of a further `r sum(!incidents$resident_id[which(!grepl("^MISSING", incidents$resident_id))] %in% unique(residents$resident_id))` reports (`r tbrounding(sum(!incidents$resident_id[which(!grepl("^MISSING", incidents$resident_id))] %in% unique(residents$resident_id))/nrow(incidents)*100)`%) were could not be successfully linked to the residents database. In total, `r sum(is.na(incidents$age) & is.na(incidents$date_of_birth))` reports (`r tbrounding(mean(is.na(incidents$age) & is.na(incidents$date_of_birth))*100)`%) did not have any date of birth or age, and `r sum(is.na(incidents$gender))` reports (`r tbrounding(mean(is.na(incidents$gender))*100)`%) did not have sex recorded. 

### Occupancy

Care home resident days are available from two sources:

- weekly home occupancy reports provided by FSHC
- individual-level resident records of last admission and discharge processing

The plots below compare both measures at the care-home level and FSHC overall.

```{r,  fig.cap = "Weekly total resident-days per care home"}
approx_occupancy <- resident_days_approx(timelines = timelines,
                                         time_span = get_time_span()
                                        ) %>% 
  dplyr::rename(home_code = home_id) %>% 
  dplyr::mutate(
    week_ending = get_monday_date(date) %m+% days(6)
  ) %>% 
  dplyr::group_by(home_code, week_ending) %>% 
  dplyr::summarise(
    approx_occupancy = sum(approx_occupancy)
  )

occ_home <- merge(
  approx_occupancy,
  occupancy,
  all = FALSE
)  

occ_global <- occ_home %>% 
  dplyr::group_by(week_ending) %>% 
  dplyr::summarise(
    approx_occupancy = sum(approx_occupancy, na.rm = T),
    occupancy = sum(occupancy, na.rm = T)
  ) 

ggplot(occ_home, aes(x = occupancy, y = approx_occupancy)) +
  geom_point() +
   geom_abline(aes(intercept = 0, slope = 1,  col = "Identity", linetype = "Identity")) +
  geom_smooth(aes(col="OLS", linetype = "OLS"), method = "lm", se = T) +
  xlab("Resident-days provided by FSHC") +
  ylab("Resident-days approximated\nfrom resident records") +
  ggtitle(paste0("Weekly total resident-days by care home (L=", dplyr::n_distinct(occ_home$home_code), ")")) +
  scale_colour_manual(name="Line of fit",
    values = c("Identity" = "black", "OLS" = "blue", "Spline" = "red")) +
  scale_linetype_manual(name="Line of fit",
    values = c("Identity" = "solid", "OLS" = "longdash", "Spline" = "dotted")) 
 
```
```{r, fig.cap = "Weekly total resident-days"}

ggplot(occ_global, aes(x = occupancy, y = approx_occupancy)) +
  geom_point() +
   geom_abline(aes(intercept = 0, slope = 1,  col = "Identity", linetype = "Identity")) +
  geom_smooth(aes(col="OLS", linetype = "OLS"), method = "lm", se = T) +
  xlab("Resident-days provided by FSHC") +
  ylab("Resident-days approximated from resident records") +
  ggtitle("Weekly total resident-days across FSHC") +
  scale_colour_manual(name="Line of fit",
    values = c("Identity" = "black", "OLS" = "blue", "Spline" = "red")) +
  scale_linetype_manual(name="Line of fit",
    values = c("Identity" = "solid", "OLS" = "longdash", "Spline" = "dotted")) 
```

### Comparison of manager-reported tally counts with Datix-derived counts

FSHC regional managers 


```{r}
ch_data <- table_weekly_cases_home()
ch_data_all <- ch_data %>% 
  dplyr::filter(week_starting <= "2020-05-04") %>% 
  dplyr::group_by(home_code, home_name_datix, home_name_clickview) %>% 
  dplyr::summarise(
    resident_days = sum(occupancy_imputed, na.rm = T),
    first_symptomatic = sum(first_symptomatic, na.rm = T),
    tally_first_symptomatic = sum(tally_first_symptomatic, na.rm = T),
    first_confirmed = sum(first_confirmed, na.rm = T),
    tally_confirmed = sum(tally_confirmed, na.rm = T)
  ) %>% 
  dplyr::mutate(
    home_code_lbl = if_else(tally_first_symptomatic>15, home_code, NA_character_),
    home_code_lbl2 = if_else(tally_confirmed>15 | first_confirmed>10, home_code, NA_character_))

ggplot(data = ch_data_all, aes(x = tally_first_symptomatic, y = first_symptomatic)) + 
  geom_point() +
  geom_text(aes(label = home_code_lbl), check_overlap = TRUE, 
            nudge_x = .5,  nudge_y = 1, vjust = "outward", hjust = "outward") + 
  geom_abline(aes(intercept = 0, slope = 1,  col = "Identity", linetype = "Identity")) +
  geom_smooth(aes(col="OLS", linetype = "OLS"), method = "lm", se = T) +
  xlab("Manager counts") + ylab("Datix-derived counts") + labs(title="Comparison of Datix and manager counts of symptomatic cases") +
  scale_colour_manual(name="Line of fit",
    values = c("Identity" = "black", "OLS" = "blue", "Spline" = "red")) +
  scale_linetype_manual(name="Line of fit",
    values = c("Identity" = "solid", "OLS" = "longdash", "Spline" = "dotted")) 
 
  

```


```{r warning=TRUE}

ggplot(data = ch_data_all, aes(x = tally_confirmed, y = first_confirmed)) + 
  geom_point() +
  geom_text(aes(label = home_code_lbl2), check_overlap = TRUE, 
            nudge_x = .5,  nudge_y = 1, vjust = "outward", hjust = "outward") + 
  geom_abline(aes(intercept = 0, slope = 1,  col = "Identity", linetype = "Identity")) +
  geom_smooth(aes(col="OLS", linetype = "OLS"), method = "lm", se = T) +
  xlab("Manager counts") + ylab("Datix-derived counts") + labs(title="Comparison of Datix and manager counts of confirmed cases") +
  scale_colour_manual(name="Line of fit",
    values = c("Identity" = "black", "OLS" = "blue", "Spline" = "red")) +
  scale_linetype_manual(name="Line of fit",
    values = c("Identity" = "solid", "OLS" = "longdash", "Spline" = "dotted")) 

```
